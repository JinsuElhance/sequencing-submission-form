<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="/static/js/dropzone.min.js"></script>
    <link href="/static/css/dropzone.min.css" rel="stylesheet" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <title>Upload data</title>
</head>
<body>
    <div id="step1">
      <h3> Step 1: upload key file (csv) </h3>
      <form
          method="POST"
          action="/uploadcsv"
          class="dropzone dz-clickable"
          id="csvDropper"
          enctype="multipart/form-data"
      >
      </form>
      <div id="csv_msg"></div>
    </div>
    <div id="step2" style="opacity: 0.5;">
      <h3> Step 2: upload gz file with sample data </h3>
      <form
          method="POST"
          action="/upload"
          class="dropzone dz-clickable"
          id="otherDropper"
          enctype="multipart/form-data"
          style="display: none;"
      >
      </form>

      <div id="bucketProgress">Bucket Transfer Progress: 0%</div> 
      
    </div>
    <div id="step3">
      <h3> Step 3: Process files with uploaded file </h3>
      <div> PLACEHOLDER FOR THIRD STEP </div>
    </div>    
    <script type="application/javascript">
        let progressTrackers = {}; // To track progress for each file
        Dropzone.options.csvDropper = {
            paramName: "file",
            url: "/uploadcsv", // Set the specific endpoint for CSV
            maxFilesize: 1, // MB
            acceptedFiles: '.csv',
            init: function () {
                this.on("error", function (file, errorMessage, xhr) {
                    if (xhr && xhr.responseText) {
                        var response = JSON.parse(xhr.responseText);
                        $("#csv_msg").html('<span class="text-danger">' + response.error + '</span>');
                    } else {
                        $("#csv_msg").html('<span class="text-danger">' + errorMessage + '</span>');
                    }
                });
                this.on("success", function (file, response) {
                    $("#csv_msg").html('<span class="text-success">' + response + '</span>');
                    $('#step2').css('opacity', '1');
                    $('#otherDropper').show(); // Show the dropzone area                    
                });             
            }
        };
        
        Dropzone.options.otherDropper = {
            paramName: "file",
            chunking: true,
            forceChunking: true,
            acceptedFiles : ".tar,.gz",
            url: "/upload",
            maxFilesize: 25025, // megabytes
            chunkSize: 1000000, // bytes
            maxFiles: 1, // Restrict to accept only one file

            sending: function(file, xhr, formData) {
                let file_uuid = file.upload.uuid;

                if (file_uuid && !progressTrackers[file_uuid]) {
                    progressTrackers[file_uuid] = true;
                    updateProgress(file_uuid);
                }
            }
        }

        let intervals = {}; // To store interval IDs for each file upload

        function updateProgress(file_uuid) {
            console.log('We will now start calling for updates');

            // Clear any existing interval for the same file upload
            clearInterval(intervals[file_uuid]);

            intervals[file_uuid] = setInterval(function () {
                $.ajax({
                    url: `/uploadprogress?file_uuid=${file_uuid}`,
                    type: 'GET',
                    success: function(data) {
                        let progress = data.progress;
                        $('#bucketProgress').text(`Bucket Transfer Progress: ${progress}%`);

                        if (progress >= 100) {
                            clearInterval(intervals[file_uuid]); // Stop updating when progress reaches 100%
                            console.log('We will now stop calling for updates');
                        }
                    },
                    error: function() {
                        // Handle error situations
                    }
                });
            }, 5000); // Update progress every 5 seconds (adjust timing as needed)
        }
    </script>
</body>
</html>
