<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="/static/css/general.css" rel="stylesheet" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/resumable.js/1.1.0/resumable.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.0/spark-md5.min.js"></script>
    <title>Upload data</title>
</head>
<body>
  <div class="app-navbar">
    <a href="https://spun.earth" class="logo"></a>
    <div class="menu">
      <ul>
        <li><a href="https://spun.earth">Spun Website</a></li>
        <li><a href="/">App homepage</a></li>
        <li><a href="/logout">Logout</a></li>
      </ul>
    </div>
  </div>
  <div class="content" style="p-4">
    <h1> Sequencing Files Submission Form </h1>
    <div id="msg" class="text-info">{{ msg }}</div>
    <div>
      <span id="process_id_info">Process id: {{ process_id }}</span> -
      <span id="upload_folder_info">Folder: {{ uploads_folder }}</span>
    </div>
    <div id="step1" class="form-step-item">
      <h3> Step 1: upload Data File (csv) </h3>
      {% if csv_uploaded %}
        <div id="step_1_msg" class="text-success">CSV file already uploaded : {{ csv_filename }}</div>
      {% else %}
        <p> <a href="/csv_structure" target="_blank" class="text-decoration-underline">Instructions for the csv file</a> </p>

        <form
            method="POST"
            action="/uploadcsv"
            class="dropzone dz-clickable"
            enctype="multipart/form-data"
            id="step_1_form"
        >
        <input type="file" id="step_1_button" accept=".csv">
        </form>
        <div id="step_1_msg"></div>
      {% endif %}
    </div>

    <div id="cvs_data">
      <h3> Records in the csv file </h3>
      <div id="cvs_table">
        <table class="table">
          <thead>
            <tr>
              <th scope="col">#</th>
              <th scope="col">Sample ID</th>
              <th scope="col">Sequencer ID</th>
              <th scope="col">Sequencing Provider</th>
              <th scope="col">Project</th>
              <th scope="col">Region</th>
              <th scope="col">Index_1</th>
              <th scope="col">Index_2</th>
              <th scope="col">Matched files</th>
            </tr>
          </thead>

          <tbody id="cvs_records_body">
            {% if cvs_records %}
              {% for sample_id, data in cvs_records.items() %}
                <tr id="cvs_sample_{{ data.get('sample_id_safe', '') }}">
                    <td>{{ loop.index }}</td>
                    <td>{{ data.get('sample_id', '') }}</td>
                    <td>{{ data.get('sequencer_id', '') }}</td>
                    <td>{{ data.get('sequencer_provider', '') }}</td>
                    <td>{{ data.get('project', '') }}</td>
                    <td>{{ data.get('region', '') }}</td>
                    <td>{{ data.get('index_1', '') }}</td>
                    <td>{{ data.get('index_2', '') }}</td>
                    <td id="cvs_sample_files_{{ data.get('sample_id_safe', '') }}">
                      {% if matching_files_db %}
                        {% for filename, files_data in matching_files_db.items() %}
                          {% if 'csv_sample_id' in files_data %}
                            {% if filename.startswith(data['sequencer_id'].split('id', 1)[0] + 'id') %}
                              {{ filename }} <br>
                            {% endif %}
                          {% endif %}
                        {% endfor %}
                      {% endif %}
                    </td>
                </tr>
              {% endfor %}
            {% endif %}
          </tbody>
        </table>
      </div>
      <div id="showAllRows" class="text-info" style="cursor: pointer;">.</div>
    </div>

    <div id="step2" {% if not csv_uploaded %} style="opacity: 0.5;" {% endif %} class="form-step-item">
      <h3> Step 2: upload gz/tar/zip file with sample data </h3>
      <form
        method="POST"
        action="/upload"
        id="step_2_form"
        enctype="multipart/form-data"
      >
        <input type="file" id="step_2_button" name="file" multiple />
        <input type="hidden" name="process_id" value="{{ process_id }}">
      </form>
      {% if csv_uploaded %}
        <div id="step_2_msg" class="text-primary">
          {% if gz_filedata %}
              {% for filename, file_data in gz_filedata.items() %}
                  {% if 'percent_uploaded' in file_data %}
                      {% if file_data.percent_uploaded == 100 %}
                          You have uploaded the file {{ filename }}<br>
                      {% else %}
                          {% if file_data.percent_uploaded > 0 %}
                              You have previously started uploading a file: {{ filename }}<br>
                              Already uploaded: {{ file_data.percent_uploaded }}%<br>
                              Please select the same file to resume uploading<br>
                          {% endif %}
                      {% endif %}
                  {% endif %}
              {% endfor %}
          {% endif %}
        </div>
      {% else  %}
        <div id="step_2_msg"></div>
      {% endif %}
    </div>
    <div id="step3" {% if not csv_uploaded %} style="opacity: 0.5;" {% endif %} class="form-step-item">
      <h3> Step 3: Upload raw files to google storage </h3>

      <div id="step_3_progress">
        {% if gz_filedata %}
            {% for filename, file_data in gz_filedata.items() %}
                {% if 'gz_sent_to_bucket_progress' in file_data %}
                    {% if file_data.gz_sent_to_bucket_progress == 100 %}
                        <p class="text-success">File {{ filename }} has been sent to google bucket<p>
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endif %}
      </div>
      <div id="step_3_msg"></div>

    </div>
    <div id="step4" {% if not csv_uploaded %} style="opacity: 0.5;" {% endif %} class="form-step-item">
      <h3> Step 4: Unzip Raw files</h3>
      <div id="step_4_progress">
        {% if gz_filedata %}
            {% for filename, file_data in gz_filedata.items() %}
                {% if 'gz_unziped_progress' in file_data %}
                    {% if file_data.gz_unziped_progress == 100 %}
                        <p class="text-success">File {{ filename }} has been unzipped<p>
                    {% endif %}
                {% endif %}
            {% endfor %}
        {% endif %}
      </div>
      <div id="step_4_msg"></div>
    </div>
    <div id="step5" class="form-step-item">
      <h3> Step 5: Rename files</h3>
      {% if files_renamed %}
        <div id="step_5_msg" class="text-success">Files renamed</div>
        <h4 id="step_5_warning" class="text-warning"></h4>
      {% else %}
        <h4 id="step_5_warning" class="text-warning"> ONLY start this when you have uploaded successfully all your files and the unzip process has finished for all your files</h4>
        <div>
          <form
              id="step_5_form"
              method="POST"
              action="/renamefiles"
              {% if files_renamed %} style="display: none;" {% endif %}
          >
            <input type="hidden" name="process_id" value="{{ process_id }}">
            <input type="submit" class="btn btn-primary" id="step_5_button">
          </form>
        </div>
        <div id="step_5_msg"></div>
        <div id="step_5_details"></div>
      {% endif %}
    </div>
    <div id="step6" {% if not files_renamed %} style="opacity: 0.5;" {% endif %} class="form-step-item">
      <h3> Step 6: Run fastqc</h3>
      {% if fastqc_run %}
        <div id="step_6_msg" class="text-success">Fastqc and multiqc processes run</div>
      {% else %}
        <div>
          <form
              id="step_6_form"
              method="POST"
              action="/fastqcfiles"
              {% if ((not files_renamed) or (fastqc_run)) %} style="display: none;" {% endif %}
          >
            <input type="hidden" name="process_id" value="{{ process_id }}">
            <input type="submit" class="btn btn-primary" id="step_6_button">
          </form>
        </div>
        <div id="step_6_msg"></div>
        <div id="step_6_details"></div>
      {% endif %}
    </div>
    <div id="step7" {% if not fastqc_run %} style="opacity: 0.5;" {% endif %} class="form-step-item">
      <h3> Step 7: Upload fastqc and multiqc files to bucket</h3>
      {% if fastqc_run %}
        <div id="step_7_msg" class="text-success">Multiqc report uploaded to bucket</div>
      {% else %}
        <div id="step_7_msg" class="text-success"></div>
      {% endif %}
    </div>
    <div id="step8" {% if not files_renamed %} style="opacity: 0.5;" {% endif %} class="form-step-item">
      <h3> Step 8: Upload renamed fastq.gz files to project backets</h3>
      {% if renamed_sent_to_bucket %}
        <div id="step_8_msg" class="text-success">Renamed files sent to buckets</div>
      {% else %}
        <div>
          <form
              id="step_8_form"
              method="POST"
              action="/uploadrenamed"
          >
            <input type="hidden" name="process_id" value="{{ process_id }}">
            <input type="submit" class="btn btn-primary" id="step_8_button">
          </form>
        </div>
        <div id="step_8_msg"></div>
      {% endif %}
    </div>


    <h3> Files in the uploaded file </h3>
    <div id="files_table">
      <table class="table">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">Original filename</th>
            <th scope="col">Renamed to</th>
            <th scope="col">Bucket</th>
            <th scope="col">Folder</th>
            <th scope="col">Moved to bucket</th>
            <th scope="col">MultiQC report</th>
          </tr>
        </thead>
        <tbody id="files_body">
          {% if matching_files_db %}

            {% set rowspan_counts = {} %}
            {% for filename, data in matching_files_db.items() %}
              {% set rowspan = data.get('rowspan', 0) %}
              <tr>
                  <th scope="row">{{ loop.index }}</th>
                  <td>{{ filename }}</td>
                  <td>{{ data.get('new_filename', '') }}</td>
                  <td>{{ data.get('bucket', '') }}</td>
                  <td>{{ data.get('folder', '') }}</td>
                  <td>{{ data.get('uploaded', '') }}</td>
                  {% if fastqc_run %}
                    {% if rowspan > 1 %}
                      <td rowspan="{{ rowspan }}">
                          <a href="/multiqc?process_id={{ process_id }}&bucket={{ data.get('bucket', '') }}&folder={{ data.get('folder', '') }}" target="_blank">Open multiqc report</a>
                      </td>
                    {% endif %}
                  {% else %}
                    <td></td>
                  {% endif %}
              </tr>
              {% if rowspan > 1 %}
                {% set _ = rowspan_counts.update({key: rowspan - 1}) %}
              {% endif %}
            {% endfor %}
          {% endif %}
        </tbody>
      </table>
    </div>
  </div>
    <script type="application/javascript">
        let process_id = {{ process_id | default('0') }}; // To track the process from start to end.
        let gz_filedata = {{ gz_filedata|tojson if gz_filedata else '{}' }};
        let matching_files_db = {{ matching_files_db|tojson if matching_files_db else '{}' }};
        let files_renamed = {{ files_renamed if files_renamed else 0 }};

        function redrawCsvTable(cvs_records) {
          var tableBody = $('#cvs_records_body');
          tableBody.empty();

          if (cvs_records) {
            $.each(cvs_records, function(sample_id, data) {
              var newRow = $('<tr>').attr('id', 'cvs_sample_' + data.sample_id_safe);
              newRow.append(
                $('<td>').text(tableBody.children().length + 1),
                $('<td>').text(data.sample_id),
                $('<td>').text(data.sequencer_id),
                $('<td>').text(data.sequencer_provider),
                $('<td>').text(data.project),
                $('<td>').text(data.region),
                $('<td>').text(data.index_1),
                $('<td>').text(data.index_2),
                $('<td>').attr('id', 'cvs_sample_files_' + data.sample_id_safe)
              );
              tableBody.append(newRow);
            });
          }
          cvsRowsHide();
        }

        function updateCsvTable(matching_files_db) {
          $('#cvs_records_body tr').each(function() {
            var sequencerId = $(this).find('td:eq(2)').text().trim();
            var lastTd = $(this).find('td:last');
            lastTd.empty();

            if (matching_files_db) {
              $.each(matching_files_db, function(filename, filesData) {
                var filenameSequencerId = filename.split('id', 1)[0] + 'id';
                if (filename.startsWith(sequencerId.split('id', 1)[0] + 'id')) {
                  lastTd.append(filename + '<br>');
                }
              });
            }
          });
        }


        function reorderByBucketFolderAndRowspan(originalObject) {
          // Extract keys and sort based on bucket, folder, and rowspan
          const sortedKeys = Object.keys(originalObject).sort((a, b) => {
            // Check if bucket key exists in both objects
            const bucketA = originalObject[a].bucket || '';
            const bucketB = originalObject[b].bucket || '';

            // Compare buckets
            const bucketComparison = bucketA.localeCompare(bucketB);
            if (bucketComparison !== 0) {
              return bucketComparison;
            }

            // Check if folder key exists in both objects
            const folderA = originalObject[a].folder || '';
            const folderB = originalObject[b].folder || '';

            // Compare folders
            const folderComparison = folderA.localeCompare(folderB);
            if (folderComparison !== 0) {
              return folderComparison;
            }

            // Check if rowspan key exists in both objects
            const rowspanA = originalObject[a].rowspan || 0;
            const rowspanB = originalObject[b].rowspan || 0;

            // Compare rowspan, prioritize rows with rowspan
            if (rowspanA !== rowspanB) {
              return rowspanB - rowspanA;
            }

            return 0; // If everything is equal, maintain current order
          });

          // Reconstruct the object with sorted keys
          const sortedObject = sortedKeys.reduce((acc, key) => {
            acc[key] = originalObject[key];
            return acc;
          }, {});

          return sortedObject;
        }

        // Function to redraw the HTML table based on the updated dictionary
        function redrawTable(filesDict) {
            var filesDict = reorderByBucketFolderAndRowspan(filesDict);
            var tableBody = $('#files_body');
            tableBody.empty(); // Clear existing table rows

            // Iterate over the dictionary to populate the table and calculate rowspan counts
            $.each(filesDict, function(oldFilename, fileDetails) {
                var newRow = '<tr>' +
                                '<th scope="row">' + '</th>' +
                                '<td>' + oldFilename + '</td>' +
                                '<td>' + (fileDetails.new_filename || '') + '</td>' +
                                '<td>' + (fileDetails.bucket || '') + '</td>' +
                                '<td>' + (fileDetails.folder || '') + '</td>' +
                                '<td>' + '</td>';

                if (fileDetails.rowspan > 1) {
                  newRow +=         '<td rowspan="' + (fileDetails.rowspan) + '">';
                  newRow +=         '<a href="/multiqc?process_id=' + process_id + '&bucket=' + (fileDetails.bucket || '') + '&folder=' + (fileDetails.folder || '') + '" target="_blank">Open multiqc report</a>';
                  newRow +=         '</td>';
                }
                newRow +=      '</tr>';

                tableBody.append(newRow);
            });

            // Update the row numbers in the first column
            tableBody.find('tr').each(function(index) {
                $(this).find('th').text(index + 1);
            });
            updateCsvTable(filesDict);
        }

        function cvsRowsHide() {
          // Define the number of rows to show
          let cvs_rows_show = 10;
          var totalRows = $('#cvs_records_body tr').length;

          // Hide all rows after the specified number of rows
          $('#cvs_records_body tr:gt(' + (cvs_rows_show - 1) + ')').hide();

          // Check if excess rows are visible after toggling
          var excessRowsVisible = $('#cvs_records_body tr:gt(' + (cvs_rows_show - 1) + ')').is(':visible');
          if (totalRows > cvs_rows_show) {
            $('#showAllRows').text(excessRowsVisible ? 'hide excess rows' : 'only ' + cvs_rows_show + ' rows shown, click here to see them all');
          }
        }

        function cvsRowsToggle() {
          // Define the number of rows to show
          let cvs_rows_show = 10;

          // Add a click event handler to the "+" symbol
          $('#showAllRows').click(function() {
            // Toggle visibility of all rows after the specified number of rows
            $('#cvs_records_body tr:gt(' + (cvs_rows_show - 1) + ')').toggle();

            // Check if excess rows are visible after toggling
            var excessRowsVisible = $('#cvs_records_body tr:gt(' + (cvs_rows_show - 1) + ')').is(':visible');

            // Change the text of the "+" symbol based on the visibility of excess rows
            $('#showAllRows').text(excessRowsVisible ? 'hide excess rows' : 'only ' + cvs_rows_show + ' rows shown, click here to see them all');
          });
        }

        $(document).ready(function() {
          cvsRowsHide();
          cvsRowsToggle();
        });


        $(document).ready(function () {
          redrawTable(matching_files_db);
          if (files_renamed==0) {
            $('#step_8_form').hide();
          }

        });

        function hide_form_5() {
          $('#step_5_button').hide();
          $('#step_5_warning').hide();
          $('#step5').css('opacity', '0.5');
        }

        function show_form_5() {
          $('#step_5_button').show();
          $('#step_5_warning').show();
          $('#step5').css('opacity', '1');
        }

        $(document).ready(function () {
          if (!gz_filedata || Object.keys(gz_filedata).length === 0) {
            hide_form_5();
          }
        });

        function calculateMD5(file, callback, updateCallback) {
            var chunkSize = 2097152; // 2 MB chunks
            var spark = new SparkMD5.ArrayBuffer();
            var fileReader = new FileReader();
            var startTime = performance.now(); // Start timer
            var totalChunks = Math.ceil(file.size / chunkSize);
            var chunksProcessed = 0;

            fileReader.onload = function (event) {
                spark.append(event.target.result); // Append chunk to MD5 calculation
                chunksProcessed++;
                if (chunksProcessed < totalChunks) {
                    loadNext();
                } else {
                    var endTime = performance.now(); // End timer
                    var duration = endTime - startTime; // Calculate duration
                    console.log('MD5 calculated in ' + duration.toFixed(2) + ' milliseconds'); // Log duration
                    callback(spark.end());
                }
                updateCallback((chunksProcessed / totalChunks) * 100); // Update progress
            };

            fileReader.onerror = function () {
                console.warn('Error reading file');
                callback(null);
            };

            function loadNext() {
                var start = fileReader.loaded || 0;
                var end = Math.min(start + chunkSize, file.size);
                fileReader.readAsArrayBuffer(file.slice(start, end));
                fileReader.loaded = end; // Update loaded bytes
            }

            loadNext();
        }

        $(document).ready(function () {
            $('#step_1_button').on('change', function () {
                uploadCsvFile();
            });
        });

        function uploadCsvFile() {
          var fileInput = $('#step_1_button')[0];
          var file = fileInput.files[0];

          if (!file) {
              alert("Please select a file.");
              return;
          }

          var formData = new FormData();
          formData.append('file', file);

          $.ajax({
              url: '/uploadcsv',
              type: 'POST',
              data: formData,
              contentType: false,
              processData: false,
              success: function (response) {
                  // Access and use the process ID
                  process_id = response.process_id;
                  upload_folder = response.upload_folder;

                  redrawCsvTable(response.cvs_records)

                  // Update the hidden input field within the specific forms
                  var form2 = $("#step_2_form");
                  form2.find('input[name="process_id"]').val(process_id);
                  var form5 = $("#step_5_form");
                  form5.find('input[name="process_id"]').val(process_id);
                  var form6 = $("#step_6_form");
                  form6.find('input[name="process_id"]').val(process_id);
                  var form8 = $("#step_8_form");
                  form8.find('input[name="process_id"]').val(process_id);
                  $('#process_id_info').html('Process ID: ' + process_id);
                  $('#upload_folder_info').html('Folder: ' + upload_folder)

                  $('#step_1_msg').html(response.msg).removeClass('text-danger').addClass('text-success');
                  $('#step_1_button').prop('disabled', true);

                  $('#step2').css('opacity', '1');
                  $('#step_2_form').show();
                  $('#step_2_button').prop('disabled', false);
                  $('#step3').css('opacity', '1');
                  $('#step4').css('opacity', '1');
              },
              error: function (xhr) {
                if (xhr && xhr.responseText) {
                    var response = JSON.parse(xhr.responseText);
                    $("#step_1_msg").html(response.error + ' ' + response.results).addClass('text-danger').removeClass('text-info').removeClass('text-success');
                } else {
                    $("#step_1_msg").html(errorMessage).addClass('text-danger').removeClass('text-info').removeClass('text-success');
                }
              }
          });
        }

        // Initialize Resumable.js
        var allowedExtensions = ['gz', 'tar', 'zip']; // Define allowed file extensions
        var commonOptions = {
            target: '/upload',
            chunkSize: 10 * 1024 * 1024,
            testChunks: true,
            uploadMethod: 'POST',
            fileType: allowedExtensions,
            fileTypeErrorCallback: function(file, errorCount) {
                // Check if the file extension is allowed
                var fileExtension = file.name.split('.').pop().toLowerCase();
                if (!allowedExtensions.includes(fileExtension)) {
                    alert('File type not allowed! Please select a .gz, .tar, or .zip file.');
                    return false; // Cancel the file upload
                }
            },
        };
        var uploading = false;
        // Initialize Resumable.js with common options
        var r = new Resumable(commonOptions);

        // Event listener for when files are added
        r.on('filesAdded', function(files) {
            var file_index = 0;
            hide_form_5();
            files.forEach(function(file) {
                file_index = file_index +1;
                // Handle each file individually
                console.log('file added to resumable:', file);
                console.log('Unique Identifier for file:', file.uniqueIdentifier);

                var file_msg_id = 'step_2_file_' + file.uniqueIdentifier;
                var file_name = file.file.name;
                var file_row = '<div id="' + file_msg_id + '">Calculating md5 for: ' + file_name + '</div>';
                $('#step_2_msg').append( file_row );

                //Add lines for third step
                var step3_msg_id = 'step_3_file_' + file.uniqueIdentifier;
                var step3_file_row = '<div id="' + step3_msg_id + '"></div>';
                $('#step_3_progress').append( step3_file_row );

                //Add lines for fourth step
                var step4_msg_id = 'step_4_file_' + file.uniqueIdentifier;
                var step4_file_row = '<div id="' + step4_msg_id + '"></div>';
                $('#step_4_progress').append( step4_file_row );

                // Customize options for each file
                var fileOptions = {
                    query: {
                        process_id: process_id,
                        filename: file.file.name,
                        filesize: file.file.size,
                        filechunks: Math.ceil(file.file.size / r.opts.chunkSize),
                        fileindex: file.uniqueIdentifier
                    },
                };

                // Create a new Resumable instance for each file with merged options
                var resumableFile = new Resumable(Object.assign({}, commonOptions, fileOptions));

                // Assign the current file to the Resumable instance
                resumableFile.addFile(file.file);

                // Listen to events for each file
                resumableFile.on('progress', function(file) {
                  let progress =Math.round(resumableFile.progress() * 10000)/100
                  var file_msg_id = 'step_2_file_' + resumableFile.files[0].uniqueIdentifier;
                  $("#" + file_msg_id).html('Upload progress: ' + progress.toFixed(2) + '%');
                  if (progress < 100) {
                    uploading = true;
                  }
                });

                resumableFile.on('fileSuccess', function(file, message) {
                  const parsedMessage = JSON.parse(message);
                  gz_filedata = parsedMessage.gz_filedata;
                  var file_id = resumableFile.files[0].uniqueIdentifier;
                  var file_msg_id = 'step_2_file_' + file_id;
                  var file_name = file.file.name;
                  $("#" + file_msg_id).html('Upload of file ' + file_name + ' finished').addClass('text-success').removeClass('text-danger').removeClass('text-info');

                  //$('#step3').css('opacity', '1');

                  //$('#step4').css('opacity', '1');

                  // We automatically will start step 3 on the server, so lets start getting updates
                  updateProgressRawFileBucket(process_id, file_id, file_name);
                  // We automatically will start step 4 on the server, so lets start getting updates
                  updateProgressUnZip(process_id, file_id, file_name);
                  uploading = false;
                });

                // Assign file input to the Resumable instance
                resumableFile.assignBrowse(document.getElementById('step_2_button'));

                // Start upload for each file
                setTimeout(function() {
                  calculateMD5(file.file,
                      function (md5) {
                          resumableFile.opts.query.md5 = md5; // Add MD5 hash to the query parameters
                          $("#" + file_msg_id).html('Md5 for file ' + file_name + ' calculated:' + md5).addClass('text-info').removeClass('text-danger').removeClass('text-success');

                          // Enable the button after calculation is completed
                          $('#step_2_button').prop("disabled", false);

                          resumableFile.upload();

                      },
                      function (progress) {
                        if (progress<100) {
                          $("#" + file_msg_id).html('Calculating md5 for file ' + file_name + '. Progress: ' + progress.toFixed(2) + '%').addClass('text-info').removeClass('text-danger').removeClass('text-success');
                        }
                      }
                  );
                }, (file_index* 500));
            });
        });

        // Assign file input to the main Resumable instance
        r.assignBrowse(document.getElementById('step_2_button'));

        let intervals = {}; // To store interval IDs for each file upload

        function updateProgressRawFileBucket(process_id, file_id, file_name) {
            console.log('We will now start calling for updates for ProgressRawFileBucket for file id ' + file_id);

            let interval_id = 'rawtobucket_' + process_id + '_' + file_id;
            // Clear any existing interval for the same file upload
            clearInterval(intervals[interval_id]);

            intervals[interval_id] = setInterval(function () {
                $.ajax({
                    url: `/uploadprogress?process_id=${process_id}&file_id=${file_id}`,
                    type: 'GET',
                    success: function(data) {
                        let progress = data.progress;
                        gz_filedata = data.gz_filedata;

                        var step3_msg_id = 'step_3_file_' + file_id;
                        // Check if the element with id step3_msg_id exists

                        if ($('#' + step3_msg_id).length === 0) {
                            // If it doesn't exist, create it
                            var step3_file_row = $('<div id="' + step3_msg_id + '"></div>');
                            // Append it to the parent element with id step_3_progress
                            $('#step_3_progress').append(step3_file_row);
                        }
                        $('#'+step3_msg_id).text(`Bucket Transfer Progress of file ${file_name}: ${progress}%`);

                        if (progress >= 100) {
                            $('#'+step3_msg_id).addClass('text-success').removeClass('text-info');
                            clearInterval(intervals[interval_id]); // Stop updating when progress reaches 100%
                            console.log('We will now stop calling for updates in updateProgressRawFileBucket');

                        }
                    },
                    error: function() {
                        // Handle error situations
                    }
                });
            }, 5000); // Update progress every 5 seconds (adjust timing as needed)
        }

        function updateProgressAllRawFilesBucket(process_id) {
            // Get all the filenames for this process_id
            let filenames = Object.keys(gz_filedata);

            // Iterate over each filename
            filenames.forEach(filename => {
                let fileData = gz_filedata[filename];

                // Check if the fileData object has the key gz_sent_to_bucket_progress
                if (fileData.hasOwnProperty('gz_sent_to_bucket_progress')) {
                    // Check if the progress is >0 and <100
                    if (fileData.gz_sent_to_bucket_progress > 0 && fileData.gz_sent_to_bucket_progress < 100) {
                        // Call updateProgressRawFileBucket function
                        updateProgressRawFileBucket(process_id, fileData.form_fileidentifier, fileData.form_filename);
                    }
                }
            });
        }

        updateProgressAllRawFilesBucket(process_id);

        function areAllFilesUnzipped(gz_filedata) {
            // Iterate over each filename and its corresponding data
            for (const filename in gz_filedata) {
                if (gz_filedata.hasOwnProperty(filename)) {
                    const fileData = gz_filedata[filename];
                    // Check if gz_unziped_progress is not equal to 100
                    if (fileData.gz_unziped_progress !== 100) {
                        // If any file is not unzipped, return false
                        return false;
                    }
                }
            }
            // If all files are unzipped, return true
            return true;
        }


        function updateProgressUnZip(process_id, file_id, file_name) {
            console.log('We will now start calling for updates for ProgressUnZip for file ' + file_name);

            let interval_id = 'unzip_' + process_id + '_' + file_id;
            // Clear any existing interval for the same file upload
            clearInterval(intervals[interval_id]);

            intervals[interval_id] = setInterval(function () {
                $.ajax({
                    url: `/unzipprogress?process_id=${process_id}&file_id=${file_id}`,
                    type: 'GET',
                    success: function(data) {
                        let progress = data.progress;
                        gz_filedata = data.gz_filedata;
                        var step4_msg_id = 'step_4_file_' + file_id;
                        // Check if the element with id step3_msg_id exists

                        if ($('#' + step4_msg_id).length === 0) {
                            // If it doesn't exist, create it
                            var step4_file_row = $('<div id="' + step4_msg_id + '"></div>');
                            // Append it to the parent element with id step_4_progress
                            $('#step_4_progress').append(step3_file_row);
                        }
                        $('#'+step4_msg_id).text(`Unzip Progress of file ${file_name}: ${progress}%`);


                        if (progress >= 100) {
                            clearInterval(intervals[interval_id]); // Stop updating when progress reaches 100%
                            console.log('We will now stop calling for updates for ProgressUnZip for file ' + file_name);
                            $('#'+step4_msg_id).text(`File ${file_name}: ${progress}% successfully unziped`).addClass('text-success').removeClass('text-info');

                            let filesDict = data.files_dict_db;
                            redrawTable(filesDict);

                            // We should check if all available files have been uzipped
                            // and if yes, we should enable the next step
                            if (areAllFilesUnzipped(gz_filedata)) {
                              if (!uploading) {
                                show_form_5();
                              }
                            } else {
                              hide_form_5();
                            }

                            //$("#step_5_form").submit();
                        }
                    },
                    error: function() {
                        // Handle error situations
                    }
                });
            }, 10000); // Update progress every 10 seconds (adjust timing as needed)
        }

        $(document).ready(function () {
            $('#step_5_form').submit(function (event) {
                // Prevent the default form submission
                event.preventDefault();
                $('#step_5_button').prop("disabled", true);
                $('#step_5_warning').hide();
                // Get form data
                var formData = $(this).serialize();

                $.ajax({
                    type: 'POST',
                    url: '/renamefiles',
                    data: formData,
                    success: function (response) {
                        // Handle success
                        console.log('Form data submitted via AJAX successfully');
                        $('#step_5_msg').text('File renaming process finished').addClass('text-success');
                        let results = response.results;
                        let filesDict = response.files_dict;
                        // Redraw the HTML table
                        redrawTable(filesDict);

                        $('#step_5_button').hide();
                        $('#step_6_form').show();
                        $('#step6').css('opacity', '1');
                        $("#step_6_form").submit();

                        $('#step_8_form').show();
                        $('#step8').css('opacity', '1');

                    },
                    error: function (error) {
                        // Handle errors
                        console.error('Error submitting form data via AJAX', error);
                    }
                });
            });
        });


        function updateProgressMultiqc(process_id) {
            console.log('We will now start calling for updates for fastqc');

            let interval_id = 'fastq_' + process_id
            // Clear any existing interval for the same file upload
            clearInterval(intervals[interval_id]);

            intervals[interval_id] = setInterval(function () {
                $.ajax({
                    url: `/fastqcprogress?process_id=${process_id}`,
                    type: 'GET',
                    success: function(data) {
                        let process_finished = data.process_finished;
                        let filesDict = data.files_dict_db;

                        if (process_finished == 1) {
                            clearInterval(intervals[interval_id]); // Stop updating when progress reaches 100%
                            redrawTable(filesDict);
                            console.log('We will now stop calling for updates');
                            $('#step_6_msg').text('Creation of fastqc and multiqc reports finished').addClass('text-success').removeClass('text-info');
                            $('#step_6_button').hide();
                            $('#step7').css('opacity', '1');
                            $('#step_7_msg').text('Fastqc and multiqc files transfered to bucket');
                        } else {
                            $('#step_6_msg').text('Files done: ' + data.files_done + ' / ' +  data.files_main).addClass('text-info').removeClass('text-success');
                        }
                    },
                    error: function() {
                        // Handle error situations
                    }
                });
            }, 3000); // Update progress every 5 seconds (adjust timing as needed)
        }

        function updateProgressRenamedToBucket(process_id) {
            console.log('We will now start calling for updates for moving renamed files to bucket');

            let interval_id = 'moverenamed_' + process_id
            // Clear any existing interval for the same file upload
            clearInterval(intervals[interval_id]);

            intervals[interval_id] = setInterval(function () {
                $.ajax({
                    url: `/moverenamedprogress?process_id=${process_id}`,
                    type: 'GET',
                    success: function(data) {
                        let process_finished = data.process_finished;
                        if (process_finished == 1) {
                            clearInterval(intervals[interval_id]); // Stop updating when progress reaches 100%
                            console.log('We will now stop calling for updates');
                            $('#step_8_msg').text('All renamed files moved to project buckets');
                        } else {
                            $('#step_8_msg').text('Files done: ' + data.files_done + ' / ' +  data.files_main).addClass('text-info').removeClass('text-success');

                            $.each(data.files_dict, function(oldFilename, fileDetails) {
                                // Iterate through table rows in the tbody with ID 'files_body'
                                $('#files_body tr').each(function() {
                                    var currentFilename = $(this).find('td:nth-child(2)').text(); // Get the filename from the second cell
                                    if (currentFilename === oldFilename) {
                                        // Update the third cell with new_filename if it exists in fileDetails
                                        if ('uploaded' in fileDetails) {
                                            $(this).find('td:nth-child(6)').text(fileDetails.uploaded);
                                        }
                                    }
                                });
                            });
                        }
                    },
                    error: function() {
                        // Handle error situations
                    }
                });
            }, 5000); // Update progress every 5 seconds (adjust timing as needed)
        }

        $(document).ready(function () {
            $('#step_6_form').submit(function (event) {
                // Prevent the default form submission
                event.preventDefault();
                $('#step_6_button').prop("disabled", true);
                $('#step_2_form').hide();

                // Get form data
                var formData = $(this).serialize();
                var process_id = $(this).find('input[name="process_id"]').val();
                updateProgressMultiqc(process_id)

                $.ajax({
                    type: 'POST',
                    url: '/fastqcfiles',
                    data: formData,
                    success: function (response) {
                        // Handle success
                        console.log('Form data submitted via AJAX successfully');

                        $('#step_6_msg').text('Fastqc process started').addClass('text-info');
                    },
                    error: function (error) {
                        // Handle errors
                        console.error('Error submitting form data via AJAX', error);
                    }
                });
            });
        });

        $(document).ready(function () {
            $('#step_8_form').submit(function (event) {
                // Prevent the default form submission
                event.preventDefault();
                $('#step_8_button').prop("disabled", true);
                // Get form data
                var formData = $(this).serialize();
                var process_id = $(this).find('input[name="process_id"]').val();
                updateProgressRenamedToBucket(process_id)
                console.log(formData);

                $.ajax({
                    type: 'POST',
                    url: '/uploadrenamed',
                    data: formData,
                    success: function (response) {
                        // Handle success
                        console.log('Form data for upload renamed files submitted via AJAX successfully');

                        $('#step_8_msg').text('Upload renamed files process started').addClass('text-info');
                    },
                    error: function (error) {
                        // Handle errors
                        console.error('Error submitting form data via AJAX', error);
                    }
                });
            });
        });
    </script>
</body>
</html>
