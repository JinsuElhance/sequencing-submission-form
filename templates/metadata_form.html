<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="/static/css/general.css" rel="stylesheet" type="text/css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/resumable.js/1.1.0/resumable.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" integrity="sha512-jnSuA4Ss2PkkikSOLtYs8BlYIeeIK1h99ty4YfvRPAlzr377vr3CXDb7sb7eEEBYjDtcYj+AjBH3FLv5uSJuXg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js" integrity="sha512-7Pi/otdlbbCR+LnW+F7PwFcSDJOuUJB3OxtEHbg4vSMvzvJjde4Po1v4BR9Gdc9aXNUNFVUY+SK51wWT8WF0Gg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAw6r8DeUDlEO8iZdnMmPSkzWUmIYbbOPY&libraries=marker"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/spark-md5/3.0.0/spark-md5.min.js"></script>
    <title>Upload data</title>
</head>
<body>
  <div class="app-navbar">
    <a href="https://spun.earth" class="logo"></a>
    <div class="menu">
      <ul>
        <li><a href="https://spun.earth">Spun Website</a></li>
        <li><a href="/">App homepage</a></li>
        <li><a href="/logout">Logout</a></li>
      </ul>
    </div>
  </div>
  <div class="content" style="p-4">
    <h1> Metadata Submission Form </h1>
    <div id="msg" class="text-info">{{ msg }}</div>

    <div id="form_reporting">
      {% if form_reporting %}
        {% for data in form_reporting %}
          <div class="text-info">{{ data }}</div>
        {% endfor %}
      {% endif %}
    </div>

    <div id="step_1" class="form-step-item">
      <h3> Step 1: Project ID allocated to user </h3>
      <form id="step_1_form">
        <fieldset>
        {% if my_buckets|length == 0 %}
          <div>You have no assigned project. Please contact the program coordinator</div>
        {% elif my_buckets|length == 1 %}
          <div>
            <p>The only assigned project for this user is {{ my_buckets|list|first }}. If the data are for this project, proceed.</p>
            <p>If you believe your data should be in a different project, please stop the process and contact the program coordinator</p>
          </div>
          <input type="hidden" id="sequence-project-id" value="{{ my_buckets|list|first }}"/>
        {% else %}
          <div>
            <label for="sequence-project-id">Select your project:</label>
            <select id="sequence-project-id" name="bucket">
              <option value="0">------</option>
              {% for bucket_name in my_buckets %}
                <option value="{{ bucket_name }}">{{ bucket_name }}</option>
              {% endfor %}
            </select>
            <p>If you you dont see your assigned project in the list, please stop the process and contact the program coordinator</p>
          </div>
        {% endif %}
        </fieldset>
      </form>
    </div>
    <div id="step_2" class="form-step-item">
      <h3> Step 2: Tell us how you are going to run the sequencing</h3>
      <form id="step_2_form">
        <fieldset
          {% if my_buckets|length != 1 or process_data %}
           disabled="disabled"
          {% endif %}
        >
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="using_scripps"
              id="using_scripps_yes"
              value="1"
              {% if process_data and process_data.using_scripps %}
                checked
              {% endif %}
            >
            <label class="form-check-label" for="using_scripps_yes">
              We are using scripps and the data will be picked up by SPUN
            </label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="using_scripps"
              id="using_scripps_no"
              value="2"
              {% if process_data and not process_data.using_scripps %}
                checked
              {% endif %}
            >
            <label class="form-check-label" for="using_scripps_no">
              We have done our analysis and we will upload the data here.
            </label>
          </div>
        </fieldset>
      </form>
    </div>

    <div id="step_3" class="form-step-item">
      <h3> Step 3: Give us the common data for your project</h3>
      <form id="step_3_form">
        <fieldset disabled="disabled">
          {% if my_buckets|length == 1 %}
            <input type="hidden" id="step_3_sequenceProjectId" value="{{ my_buckets|list|first }}"/>
          {% else %}
            <input type="hidden" id="step_3_sequenceProjectId" value=""/>
          {% endif %}
          {% for column_key, column_values in project_common_data.items() %}
            <div class="form-group row mb-3" data-condition="{{ column_values.get('required', '') }}">
              <small class="form-text text-danger error-message" style="display: none;"></small>
              <label for="{{ column_key }}" class="col-sm-3 col-form-label">{{ column_key }}</label>
              <div class="col-sm-9">
                <small id="{{ column_key }}Help" class="form-text">{{ column_values['help_tip'] }}</small>
                {% if 'options' in column_values %}
                  <select class="form-control" id="{{ column_key }}" name="{{ column_key }}">
                    <option value="0">------</option>
                    {% for option in column_values['options'] %}
                      <option value="{{ option }}"
                        {% if process_data and process_data[column_key]|string == option %}
                          selected
                        {% endif %}
                      >{{ option }}</option>
                    {% endfor %}
                  </select>
                {% elif column_values.get('field_type') == 'date' %}
                  <input type="date" class="form-control" id="{{ column_key }}" name="{{ column_key }}"
                    {% if process_data and process_data[column_key] %}
                      value="{{ process_data[column_key] }}"
                    {% endif %}
                  >
                {% else %}
                  <input type="text" class="form-control" id="{{ column_key }}" name="{{ column_key }}"
                    placeholder="{{ column_key }}"
                    {% if process_data and process_data[column_key] %}
                      value="{{ process_data[column_key] }}"
                    {% endif %}
                  >
                {% endif %}
              </div>
            </div>
          {% endfor %}
          <button type="button" class="btn btn-secondary" id="step_3_button">Process</button>
        </fieldset>
      </form>
      <div id="step_3_msg"></div>
    </div>


    <div id="step_4" class="form-step-item">
      <h3> Step 4: Select how you are going to give us the metadata</h3>
      <div>You can give us the metadata either by </div>
      <form id="step_4_form">
        <fieldset
          {% if not process_data or process_data["metadata_upload_confirmed"] %}
            disabled="disabled"
          {% endif %}
        >
          <div class="form-check">
            <input class="form-check-input" type="radio" name="upload_method" id="upload_method_1" value="1">
            <label class="form-check-label" for="sequencing_method_1">
              Uploading a file of the format .xls or .xlsx or .csv
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="upload_method" id="upload_method_2" value="2">
            <label class="form-check-label" for="sequencing_method_2">
              Filling in the form once for each of your samples
            </label>
          </div>
        </fieldset>
      </form>
      <div id="step_4_explanation_case_1" class="explanation" style="display:none;">
        <p>You have to upload a csv or xls file that the column names EXACTLY as they appear bellow. </p>
        <p>You can read the <a href="/metadata_instructions" class="link" target="_blank">description of each field here </a></p>
        <p>You can download the <a href="/xls_sample" class="link" target="_blank">XLS template</a></p>
        <p>Or you can copy the <a href="{{ google_sheets_template_url }}" class="link" target="_blank">Template Google sheet</a>, then make a copy ("File"->"Make a copy") and work on your copy</p>
        <form
            method="POST"
            action="/upload_metadata_file"
            enctype="multipart/form-data"
            id="step_4_file_upload"
        >
          <input type="hidden" name="project_id" value="{{ project_id }}">
          <input type="hidden" name="process_id" value="{{ process_id }}">
          <input type="file" id="step_4_file_upload_button" accept=".csv, .xls, .xlsx">
        </form>
      </div>
      <div id="step_4_explanation_case_2" class="explanation" style="display:none;">
        <p>Fill in the form bellow once for each sample. Pay very good attention to the coordinates.</p>
        <p>When you enter the coordinates the map should be showing you where this was.</p>
      </div>
      <div id="step_4_filename"></div>
      <div id="step_4_msg" class="explanation">

      </div>
    </div>

    <div class="container">
      <form id="metadataForm" style="display:none">
        <input type="hidden" name="process_id" value="{{ process_id }}">
        {% for column_key, column_values in expected_columns.items() %}
            <div class="form-group row mb-3">
                <label for="{{ column_key }}" class="col-sm-3 col-form-label">{{ column_key }}</label>
                <div class="col-sm-9">
                    <small id="{{ column_key }}Help" class="form-text">{{ column_values['help_tip'] }}</small>
                    {% if 'options' in column_values %}
                        <select class="form-control" id="{{ column_key }}" name="{{ column_key }}">
                            <option value="0">------</option>
                            {% for option in column_values['options'] %}
                                <option value="{{ option }}">{{ option }}</option>
                            {% endfor %}
                        </select>
                    {% elif column_values.get('field_type') == 'date' %}
                        <input type="date" class="form-control" id="{{ column_key }}" name="{{ column_key }}">
                    {% else %}
                        <input type="text" class="form-control" id="{{ column_key }}" name="{{ column_key }}" placeholder="{{ column_key }}">
                    {% endif %}
                </div>
            </div>
        {% endfor %}

        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
      <div id="mapWrapper">
        <div id="map"></div>
      </div>
      <div id="mapCheckMessage"></div>
    </div>

    <div class="table-container">
      <h4> Your metadata </h4>
      <p>Please note: you don't need to (and you shouldn't) provide the first two columns. Our system will fill those in at a later stage</a></p>
      <table id="dataTable" class="table-bordered">
          <thead>
              <tr>
                  <th scope="col" class="bg-gray">DbID</th>
                  <th scope="col" class="bg-gray"><span class="grey">____</span>Sequencer_IDs<span class="grey">____</span></th>
                  {% for expectedColumn in expected_columns.keys() %}
                      <th scope="col">{{ expectedColumn }}</th>
                  {% endfor %}
              </tr>
          </thead>
          <tbody>
              <!-- Check if samples_data is not empty -->
              {% if samples_data %}
                  <!-- Iterate over each row in samples_data -->
                  {% for row in samples_data %}
                      <tr>
                          <td class="bg-gray">{{ row.id }}</td>
                          <td class="bg-gray">
                            {% if sequencer_ids %}
                              {% for seq in sequencer_ids %}
                                  {% if seq.sequencingSampleId == row.id %}
                                      {{ seq.Region }} : {{ seq.SequencerID }}<br/>
                                  {% endif %}
                              {% endfor %}
                            {% endif %}
                          </td>
                          <!-- Iterate over each column value for the row -->
                          {% for column in expected_columns.keys() %}
                              <td>{{ row[column] }}</td>
                          {% endfor %}
                      </tr>
                  {% endfor %}
              {% endif %}
          </tbody>
      </table>
    </div>

    <div id="step_5" class="form-step-item">
      <h3> Step 5: Confirm your locations</h3>
      <form id="step_5_form">
        <fieldset
          {% if ((not samples_data) or process_data["metadata_upload_confirmed"]) %}
           disabled="disabled"
          {% endif %}

        >
          <p>All my metadata have been uploaded and I have checked the map and all the samples seem to be in the correct locations.</p>
          <input type="hidden" name="process_id" value="{{ process_id }}">
          <input type="button" id="step_5_button" value="I confirm">
        </fieldset>
      </form>
      <div id="step_5_msg"></div>
    </div>

    <div
      id="step_6-container"
      {% if process_data and process_data.using_scripps %}
        style="display:none"
      {% endif %}
    >
      <div id="step_6" class="form-step-item">
        <h3> Step 6: Provide the sequencer ID</h3>

        <form id="step_6_form">
          <fieldset
            {% if not process_data["metadata_upload_confirmed"] %}
             disabled="disabled"
            {% endif %}
          >
          <p>
            For each sample we expect two different pairs of sequencing fastq files, on two different sequencing regions - i.e. four files in total.
          </p>
          <p>
            Your sequencing provider should generate two files (one forward and one reverse) for each region.
          </p>
          <p>
            For each region, the pair of files should have in their filename, a common first part, and then the number 1 or 2 followed by some more text and an ending of .fastq.gz
          </p>
          <p>
            For example, in a previous sequencing process, the for the sample Greece22_1 , there were 4 files produced:
            <ul>
              <li>Forward file for region ITS2: <span class="blue">071id071_R</span><span class="red">1</span><span class="green">_001</span><span class="orange">.fastq.gz</span> </li>
              <li>Reverse file for region ITS2: <span class="blue">071id071_R</span><span class="red">2</span><span class="green">_001</span><span class="orange">.fastq.gz</span></li>
              <li>Forward file for region SSU: <span class="blue">194id194_R</span><span class="red">1</span><span class="green">_001</span><span class="orange">.fastq.gz</span></li>
              <li>Reverse file for region SSU: <span class="blue">194id194_R</span><span class="red">2</span><span class="green">_001</span><span class="orange">.fastq.gz</span></li>
            </ul>
            In the example of the first two files<br/>
            <ul>
              <li>A) <span class="blue">071id071_R</span> was the common part of the filename for a sequencing region</li>
              <li>B) <span class="red">1</span> and <span class="red">2</span> was the part that was indicating the forward and reverse reads</li>
              <li>C) <span class="green">_001</span> was another part of the name that we are not interested in at this moment</li>
              <li>D) <span class="orange">.fastq.gz</span> was the file type</li>
            </ul>
            We will call <span class="fw-bold">SequencerID</span> the <span class="blue">part (A) part of the filename</span>, and we will need you to provide us this information so that we can match the files to your samples
          </p>
          <p>
            You can either upload a .xls, .xlsx, .csv file with the following data, or you can fill it in using the form bellow.
          </p>
          <p>
            Your .xls, .xlsx, .csv file should have three columns with <span class="fw-bold">exactly</span> those column names:
            <ul>
              <li><span class="fw-bold">SampleID</span>, which should match the SampleID from your metadata</li>
              <li>
                {% if regions|length == 1 %}
                  <span class="fw-bold">Region</span>, which should be the region sequenced: <span class="fw-bold">{{ regions[0] }}</span>
                {% else %}
                  <span class="fw-bold">Region</span>, which should be the region sequenced. Depending on the primer sets you chose above, one of:
                  <ul>
                    {% for region in regions %}
                      <li>{{ region }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}
              </li>
              <li><span class="fw-bold">SequencerID</span>, which should be the part (A) (the blue part, the common part) of the filenames as the example above</li>
              <li><span class="fw-bold">Index_1</span>, which should be the DNA sequencing index 1 (if you know it)</li>
              <li><span class="fw-bold">Index_2</span>, which should be the DNA sequencing index 2 (if you know it)</li>
            </ul>
          </p>
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="upload_sequencerids_method"
                id="upload_sequencerids_method_file"
                value="1"
              >
              <label class="form-check-label" for="upload_sequencerids_method_file">
                I am going to upload a .xls, .xlsx, .csv file
              </label>
            </div>
            <div class="form-check">
              <input
                class="form-check-input"
                type="radio"
                name="upload_sequencerids_method"
                id="upload_sequencerids_method_form"
                value="2"
              >
              <label class="form-check-label" for="upload_sequencerids_method_form">
                I am going to fill in the form with my data
              </label>
            </div>
          </fieldset>
        </form>
        <div id="step_6_case_1" class="explanation" style="display:none;">
          <form
              method="POST"
              action="/upload_sequencer_ids_file"
              enctype="multipart/form-data"
              id="step_6_file_upload"
          >
            <input type="hidden" name="process_id" value="{{ process_id }}">
            <input type="file" id="step_6_file_upload_button" accept=".csv, .xls, .xlsx">
          </form>
        </div>
        <div id="step_6_case_2" class="explanation" style="display:none;">
          <form id="sequencerIdsForm" style="display:none">
            <input type="hidden" name="process_id" value="{{ process_id }}">
            <div class="form-group row mb-3">
                <label for="sequencer_sample_id" class="col-sm-3 col-form-label">SampleID</label>
                <div class="col-sm-9">
                    <small id="sequencer_sample_idHelp" class="form-text">Select one of the provided sample IDs</small>
                    <select class="form-control" id="sequencer_sample_id" name="sequencer_sample_id">
                      <option value="0">------</option>
                      {% for sample in samples_data %}
                        {% if sample['id'] in missing_sequencing_ids %}
                            <option value="{{ sample['id'] }}">{{ sample['SampleID'] }}</option>
                        {% endif %}
                      {% endfor %}
                    </select>
                </div>
            </div>

            <div class="form-group row mb-3">
                <label for="sequencer_region" class="col-sm-3 col-form-label">Region</label>
                <div class="col-sm-9">

                    {% if regions|length == 1 %}
                      <input type="hidden" name="sequencer_region" value="{{ regions[0] }}">
                      <small id="sequencer_regionHelp" class="form-text">You have chosen a single Primer set, and the region is:</small>
                      <select class="form-control" name="sequencer_region_dummy" disabled>
                          {% for region in regions %}
                              <option value="{{ region }}">{{ region }}</option>
                          {% endfor %}
                      </select>
                    {% else %}
                      <small id="sequencer_regionHelp" class="form-text">Select one of the provided regions</small>
                      <select class="form-control" id="sequencer_region" name="sequencer_region">
                          <option value="0">------</option>
                          {% for region in regions %}
                              <option value="{{ region }}">{{ region }}</option>
                          {% endfor %}
                      </select>
                    {% endif %}

                </div>
            </div>

            <div class="form-group row mb-3">
                <label for="sequencer_id" class="col-sm-3 col-form-label">SequencerID</label>
                <div class="col-sm-9">
                    <small id="sequencer_idHelp" class="form-text">Provide the sequencer ID as explained above</small>
                    <input type="text" class="form-control" id="sequencer_id" name="sequencer_id" >
                </div>
            </div>

            <div class="form-group row mb-3">
                <label for="index_1" class="col-sm-3 col-form-label">Index_1</label>
                <div class="col-sm-9">
                    <small id="index_1Help" class="form-text">Provide the index_1 as explained above</small>
                    <input type="text" class="form-control" id="index_1" name="index_1" >
                </div>
            </div>
            
            <div class="form-group row mb-3">
                <label for="index_2" class="col-sm-3 col-form-label">Index_2</label>
                <div class="col-sm-9">
                    <small id="index_2Help" class="form-text">Provide the index_2 as explained above</small>
                    <input type="text" class="form-control" id="index_2" name="index_2" >
                </div>
            </div>


            <button type="submit" class="btn btn-primary">Submit</button>
          </form>
          <div id="sequencerIdsForm_message"></div>
        </div>
        <div id="step_6_filename"></div>
        <div id="step_6_msg"></div>
      </div>
      {% if process_data and not process_data.using_scripps %}
        <div id="next_to_step_6" class="next-to-step">
          <h4> Expected number of files per sequence is {{ nr_files_per_sequence }} </h4>
          <h4> Number of sequencing regions is {{ process_data["Sequencing_regions_number"] }} </h4>
          <table id="samplesTable" class="table-bordered">
              <thead>
                  <tr>
                      <th scope="col" class="bg-gray">DbID</th>
                      <th scope="col" class="bg-gray">SampleID</th>
                      <th scope="col" class="bg-gray"><span class="grey">____</span>Sequencer<span class="grey">_</span>ID<span class="grey">____</span></th>
                      <th scope="col" class="bg-gray"><span class="grey">____</span>Region<span class="grey">____</span></th>
                      <th scope="col" class="bg-gray"><span class="grey">____</span>Index_1<span class="grey">____</span></th>
                      <th scope="col" class="bg-gray"><span class="grey">____</span>Index_2<span class="grey">____</span></th>
                      <th scope="col" class="bg-gray">Files</th>
                  </tr>
              </thead>

              <tbody>
                {% set seq_data_dict = {} %}

                {# First, populate seq_data_dict with sequencer data grouped by row.id #}
                {% for row in samples_data %}
                    {% set seq_data_list = [] %}
                    {% for seq in sequencer_ids %}
                        {% if seq.sequencingSampleId == row.id %}
                            {% set seq_data = {
                                'id': seq.id,
                                'SequencerID': seq.SequencerID,
                                'Region': seq.Region,
                                'Index_1': seq.Index_1,
                                'Index_2': seq.Index_2
                            } %}
                            {% set _ = seq_data_list.append(seq_data) %}
                        {% endif %}
                    {% endfor %}
                    {% set _ = seq_data_dict.update({row.id: seq_data_list}) %}
                {% endfor %}

                {% if nr_files_per_sequence == 2 %}
                  <!-- Iterate over each row in samples_data -->
                  {% for row in samples_data %}
                      {% set seq_data = seq_data_dict[row.id] %}
                      {% if seq_data and seq_data|length > 0 %}
                          {% set files = uploaded_files | selectattr("sequencerId", "equalto", seq_data[0]["id"]) | list %}
                      {% else %}
                          {% set files = [] %}
                      {% endif %}
                      <tr>
                          <td class="bg-gray" rowspan="{{ process_data["Sequencing_regions_number"]* nr_files_per_sequence }}">{{ row.id }}</td>
                          <td class="bg-gray" rowspan="{{ process_data["Sequencing_regions_number"]* nr_files_per_sequence }}">{{ row["SampleID"] }}</td>
                          <td id="S_{{ row.id }}_1" rowspan="{{ nr_files_per_sequence }}">
                            {% if seq_data_dict[row.id][0] %}
                              {{ seq_data_dict[row.id][0]["SequencerID"] }}
                            {% endif %}
                          </td>
                          <td id="R_{{ row.id }}_1" rowspan="{{ nr_files_per_sequence }}">
                            {% if seq_data_dict[row.id][0] %}
                              {{ seq_data_dict[row.id][0]["Region"] }}
                            {% endif %}
                          </td>
                          <td id="I1_{{ row.id }}_1" rowspan="{{ nr_files_per_sequence }}">
                            {% if seq_data_dict[row.id][0] %}
                              {{ seq_data_dict[row.id][0]["Index_1"] }}
                            {% endif %}
                          </td>
                          <td id="I2_{{ row.id }}_1" rowspan="{{ nr_files_per_sequence }}">
                            {% if seq_data_dict[row.id][0] %}
                              {{ seq_data_dict[row.id][0]["Index_2"] }}
                            {% endif %}
                          </td>
                          <td id="F_{{ seq_data|length > 0 and seq_data[0]['id'] or 'N/A' }}_A">
                            {% if files and files[0] %}
                              {{ files[0].original_filename }}
                            {% else %}
                              <span class="red"> Not uploaded </span>
                            {% endif %}
                          </td>
                      </tr>

                      <tr>
                        <td id="F_{{ seq_data|length > 0 and seq_data[0]['id'] or 'N/A' }}_B">
                          {% if files and files|length > 1 %}
                            {{ files[1].original_filename }}
                          {% else %}
                            <span class="red"> Not uploaded </span>
                          {% endif %}
                        </td>
                      </tr>

                      {% if process_data["Sequencing_regions_number"]>1 %}
                        <tr>
                          <td id="S_{{ row.id }}_2" rowspan="{{ nr_files_per_sequence }}">
                            {% if seq_data_dict[row.id][1] %}
                              {{ seq_data_dict[row.id][1]["SequencerID"] }}
                            {% endif %}
                          </td>
                          <td id="R_{{ row.id }}_2" rowspan="{{ nr_files_per_sequence }}">
                            {% if seq_data_dict[row.id][1] %}
                              {{ seq_data_dict[row.id][1]["Region"] }}
                            {% endif %}
                          </td>
                          <td id="I1_{{ row.id }}_2" rowspan="{{ nr_files_per_sequence }}">
                            {% if seq_data_dict[row.id][1] %}
                              {{ seq_data_dict[row.id][1]["Index_1"] }}
                            {% endif %}
                          </td>
                          <td id="I2_{{ row.id }}_2" rowspan="{{ nr_files_per_sequence }}">
                            {% if seq_data_dict[row.id][1] %}
                              {{ seq_data_dict[row.id][1]["Index_2"] }}
                            {% endif %}
                          </td>
                          <td id="F_{{ seq_data|length > 1 and seq_data[1]['id'] or 'N/A' }}_A">
                            {% if files and files[0] %}
                              {{ files[0].original_filename }}
                            {% else %}
                              <span class="red"> Not uploaded </span>
                            {% endif %}
                          </td>
                        </tr>
                        <tr>
                          <td id="F_{{ seq_data|length > 1 and seq_data[1]['id'] or 'N/A' }}_B">
                            {% if files and files|length > 1 %}
                              {{ files[1].original_filename }}
                            {% else %}
                              <span class="red"> Not uploaded </span>
                            {% endif %}
                          </td>
                        </tr>
                      {% endif %}

                  {% endfor %}
                {% endif %}

                {% if nr_files_per_sequence == 1 %}
                  <!-- Iterate over each row in samples_data -->
                  {% for row in samples_data %}
                    {% set seq_data = seq_data_dict.get(row.id, []) %}
                    {% if seq_data %}
                        {% set files = uploaded_files | selectattr("sequencerId", "equalto", seq_data[0]["id"]) | list %}
                    {% else %}
                        {% set files = [] %}
                    {% endif %}
                    <tr>
                      <td class="bg-gray" rowspan="{{ process_data['Sequencing_regions_number'] }}">{{ row.id }}</td>
                      <td class="bg-gray" rowspan="{{ process_data['Sequencing_regions_number'] }}">{{ row['SampleID'] }}</td>
                      <td id="S_{{ row.id }}_1" rowspan="{{ nr_files_per_sequence }}">
                        {% if seq_data|length > 0 %}
                          {{ seq_data[0]['SequencerID'] }}
                        {% endif %}
                      </td>
                      <td id="R_{{ row.id }}_1" rowspan="{{ nr_files_per_sequence }}">
                        {% if seq_data|length > 0 %}
                          {{ seq_data[0]['Region'] }}
                        {% endif %}
                      </td>
                      <td id="I1_{{ row.id }}_1" rowspan="{{ nr_files_per_sequence }}">
                        {% if seq_data|length > 0 %}
                          {{ seq_data[0]['Index_1'] }}
                        {% endif %}
                      </td>
                      <td id="I2_{{ row.id }}_1" rowspan="{{ nr_files_per_sequence }}">
                        {% if seq_data|length > 0 %}
                          {{ seq_data[0]['Index_2'] }}
                        {% endif %}
                      </td>
                      <td id="F_{{ seq_data|length > 0 and seq_data[0]['id'] or 'N/A' }}_A">
                        {% if files and files[0] %}
                          {{ files[0]['original_filename'] }}
                        {% else %}
                          <span class="red"> Not uploaded </span>
                        {% endif %}
                      </td>
                    </tr>

                    {% if process_data['Sequencing_regions_number'] > 1 and seq_data|length > 1 %}
                      <tr>
                        <td id="S_{{ row.id }}_2" rowspan="{{ nr_files_per_sequence }}">
                          {% if seq_data[1] %}
                            {{ seq_data[1]['SequencerID'] }}
                          {% endif %}
                        </td>
                        <td id="R_{{ row.id }}_2" rowspan="{{ nr_files_per_sequence }}">
                          {% if seq_data[1] %}
                            {{ seq_data[1]['Region'] }}
                          {% endif %}
                        </td>
                        <td id="I1_{{ row.id }}_2" rowspan="{{ nr_files_per_sequence }}">
                          {% if seq_data[1] %}
                            {{ seq_data[1]['Index_1'] }}
                          {% endif %}
                        </td>
                        <td id="I2_{{ row.id }}_2" rowspan="{{ nr_files_per_sequence }}">
                          {% if seq_data[1] %}
                            {{ seq_data[1]['Index_2'] }}
                          {% endif %}
                        </td>
                        <td id="F_{{ seq_data[1]['id'] }}_A">
                          {% if files|length > 1 %}
                            {{ files[1]['original_filename'] }}
                          {% else %}
                            <span class="red"> Not uploaded </span>
                          {% endif %}
                        </td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                {% endif %}

              </tbody>
          </table>
        </div>
      {% endif %}
    </div>

    {% if process_data and not process_data.using_scripps %}
      <div id="step_7" class="form-step-item">
        <h3> Step 7: Confirm that all possible sequence ids have been provided</h3>
        
        <div id="step_7_missing_ids">
          {% if missing_sequencing_ids %}
            <h4> The following samples are missing one or more of their expected regions </h4>
            <ul>
            {% for row in samples_data %}
              {% if row["id"] in missing_sequencing_ids %}
                <li>{{ row["SampleID"] }}</li>
              {% endif %}
            {% endfor %}
            </ul>         
          {% endif %}
        </div>
        <form id="step_7_form">
          <fieldset
            {% if (not sequencer_ids) %}
             disabled="disabled"
            {% endif %}

          >
            <p>I confirm that we will not have sequencing files for the samples above.</p>
            <input type="hidden" name="process_id" value="{{ process_id }}">
            <input type="button" id="step_7_button" value="I confirm">
          </fieldset>
        </form>        
      </div>


      <div id="step_8" class="form-step-item">
        <h3> Step 8: Upload the fastq files</h3>
        <form
          method="POST"
          action="/sequencing_file_upload"
          id="step_8_form"
          enctype="multipart/form-data"
        >
          <fieldset
            {% if not valid_samples %}
             disabled="disabled"
            {% endif %}
          >
            <input type="file" id="step_8_upload_file_button" name="file" multiple />
            <input type="hidden" name="process_id" value="{{ process_id }}">
          </fieldset>
        </form>
        <div id="step_8_filename"></div>
        <div id="step_8_msg" class="explanation">
      </div>
    {% endif %}
  </div>

  <script type="application/javascript">
  var markersArray = [];
  var project_common_data = JSON.parse('{{ project_common_data|tojson|safe }}');
  var samples_data = JSON.parse('{{ samples_data|tojson|safe }}');
  var sequencing_regions_number = {{ process_data["Sequencing_regions_number"] if process_data["Sequencing_regions_number"] else 0 }};
  ////// ############################################# /////////
  ////// ############ STEP 2 STARTS HERE ############# /////////
  ////// ############################################# /////////
  $(document).ready(function() {
    function enableForm_step_2() {
        $('#step_2_form fieldset').removeAttr('disabled');
        $('#step_1_form fieldset').attr('disabled', 'disabled');
    }

    // Listen for changes in the radio buttons using_scripps
    $('input[name="using_scripps"]').change(function() {
        // Check if any radio button is checked
        if ($('input[name="using_scripps"]:checked').length > 0) {
            enableForm_step_3(); // Enable the next form
        } else {
            $('#step_3_form fieldset').attr('disabled', 'disabled'); // Ensure the form is disabled if no radio button is checked
        }

        updateFields_step_3();

        // Hide step 6 if they choose scripps
        var usingScrippsYesChecked = $('#using_scripps_yes').is(':checked');
        if (usingScrippsYesChecked) {
          $('#step_6-container').hide();
        }
    });
  });

  ////// ############################################# /////////
  ////// ############ STEP 3 STARTS HERE ############# /////////
  ////// ############################################# /////////
  function enableForm_step_3() {
      $('#step_3_form fieldset').removeAttr('disabled');
      $('#step_2_form fieldset').attr('disabled', 'disabled');
  }
  function updateFields_step_3() {
    var usingScrippsNoChecked = $('#using_scripps_no').is(':checked');

    $('#step_3_form .form-group').each(function() {
      var condition = $(this).data('condition');
      if ((condition === "IfNotScripps") || (condition === "OptionalIfNotScripps")) {
        if (usingScrippsNoChecked) {
          $(this).show(); // Show the form group if condition matches and using_scripps_no is checked
        } else {
          $(this).hide(); // Hide the form group if condition matches and using_scripps_no is not checked
        }
      }
    });
  }
  $(document).ready(function() {
      // Listen for changes in the select drop down project_id (bucket)
      $('#sequence-project-id').change(function() {
          var selectedValue = $(this).val();
          enableForm_step_2(); // Enable the next form
          $('#step_3_sequenceProjectId').val(selectedValue);
          // You can add more code here to handle the change event
      });

      // Function to validate Step 3 fields
      function validateFieldsAndUpload_step_3() {
          var isValid = true;

          var formData = new FormData();
          // Get the value of the selected radio button from the using_scripps form
          var usingScrippsValue = $('input[name="using_scripps"]:checked').val();
          var usingScrippsText = usingScrippsValue == "1" ? "yes" : "no";
          formData.append('using_scripps', usingScrippsText);

          if ($('#sequence-project-id').is('input')) {
              var project_id = $('#sequence-project-id').val();
              console.log("Project ID from input field:", project_id);
          }
          // Check if the element is a select field
          else if ($('#sequence-project-id').is('select')) {
              $('#sequence-project-id').change(function() {
                  var project_id = $(this).val();
                  console.log("Selected Project ID from select field:", project_id);
              });
          }
          formData.append('project_id', project_id);

          $('#step_3_form .form-group').each(function() {
              var condition = $(this).data('condition');
              var input = $(this).find(':input');
              var fieldName = input.attr('name');
              var fieldValue = input.val();
              formData.append(fieldName, fieldValue);
              var errorMessage = $(this).find('.error-message');

              if ((condition === "True") || (condition === "IfNotScripps" && $('#using_scripps_no').is(':checked'))) {
                  // If condition requires field to be validated and using_scripps_no is not checked
                  if (input.is('select')) {
                      if (input.val() === "0") { // Assuming "0" is the default value
                          isValid = false;
                          errorMessage.text('Please select an option.').show();
                      } else {
                          errorMessage.text('').hide();
                      }
                  } else if (input.is('input[type="text"], input[type="date"]')) {
                      if (input.val() === "") {
                          isValid = false;
                          errorMessage.text('This field is required.').show();
                      } else {
                          errorMessage.text('').hide();
                      }
                  }
              } else {
                  errorMessage.text('').hide(); // Clear error message if condition is not met
              }
          });

          if (isValid) {
            $.ajax({
                url: '/upload_process_common_fields',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    if (response.result=="ok") {
                      window.location.replace("/metadata_form?process_id=" + response.process_id);
                    }

                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    $('#step_3_msg').html("<p>An error occurred while processing the file.</p>").removeClass('text-success').addClass('text-danger');

                }
            });
          }

          return isValid;
      }


      // Validate Step 3 fields and enable Step 4 form on button click
      $('#step_3_button').click(function() {
          if (validateFieldsAndUpload_step_3()) {
              enableForm_step_4(); // Enable Step 4 form if Step 3 fields are valid
              $('#step_3_msg').text(`All data check out`).addClass('text-success').removeClass('text-info');
          } else {
              // Optionally, show error message or handle validation errors
              $('#step_3_msg').text(`Please fill out all required fields in Step 3.`).addClass('text-info').removeClass('text-success');
          }
      });

      updateFields_step_3();
  });
  ////// ############################################# /////////
  ////// ############ STEP 3 ENDS HERE ############### /////////
  ////// ############################################# /////////


  ////// ############################################# /////////
  ////// ####### STEP 4 CHOOSE METHOD STARTS HERE #### /////////
  ////// ############################################# /////////
  function enableForm_step_4() {
      $('#step_4_form fieldset').removeAttr('disabled');
      $('#step_3_form fieldset').attr('disabled', 'disabled');
  }

  $(document).ready(function() {
    ////// Choose upload method (form or file) ///////
    $('input[name="upload_method"]').change(function() {
      if (this.value == '1') {
        $('#step_4_explanation_case_1').show();
        $('#step_4_explanation_case_2').hide();
        $('#metadataForm').hide();
      } else if (this.value == '2') {
        $('#step_4_explanation_case_1').hide();
        $('#step_4_explanation_case_2').show();
        $('#metadataForm').show();
      }
    });
  });
  ////// ############################################# /////////
  ////// ####### STEP 4 CHOOSE METHOD ENDS HERE ###### /////////
  ////// ############################################# /////////


  ////// ############################################# /////////
  ////// ####### STEP 4 UPLOAD FILE STARTS HERE ###### /////////
  ////// ############################################# /////////
  $(document).ready(function() {
    $('#step_4_file_upload_button').on('change', function () {
        uploadMetadataFile();
    });
    function uploadMetadataFile() {
        var fileInput = $('#step_4_file_upload_button')[0];
        var file = fileInput.files[0];

        if (file) {
            var fileName = file.name;
            $('#step_4_filename').html("<h4>File uploaded: " + fileName + "</h4>");
        }

        if (!file) {
            alert("Please select a file.");
            return;
        }

        // Clear previous table data
        $('#dataTable tbody').empty();

        // Get the value of the selected radio button from the using_scripps form
        var usingScrippsValue = $('input[name="using_scripps"]:checked').val();
        var usingScrippsText = usingScrippsValue == "1" ? "yes" : "no";

        var formData = new FormData();
        formData.append('file', file);
        // formData.append('project_id', 1);
        formData.append('using_scripps', usingScrippsText);

        var form = $('#step_4_file_upload_button').closest('form');
        var processId = form.find('input[name="process_id"]').val();
        formData.append('process_id', processId);

        // Append data from step 3 form
        $('#step_3_form .form-group').each(function() {
            var input = $(this).find(':input');
            var fieldName = input.attr('name');
            var fieldValue = input.val();
            formData.append(fieldName, fieldValue);
        });

        $.ajax({
            url: '/upload_metadata_file',
            type: 'POST',
            data: formData,
            contentType: false,
            processData: false,
            success: function(response) {
                console.log(response);

                // Clear previous messages and reset status class
                $('#step_4_msg').empty().removeClass('text-success text-danger');
                var statusClass = 'text-success';

                // Clear previous markers from the map
                if (window.markersArray) {
                    markersArray.forEach(function(marker) {
                        marker.setMap(null);
                    });
                } else {
                    window.markersArray = [];
                }

                bounds = new google.maps.LatLngBounds();

                // Function to handle issues dynamically
                function handleIssues(fieldName, fieldData) {
                    if ((fieldData && fieldData.invalid) || (fieldData && fieldData.empty_values) || (fieldData && fieldData.missing)) {
                        var issueMsg = "<h4>Problems with field " + fieldName + "</h4>";
                        $('#step_4_msg').append(issueMsg);
                        if (fieldData && fieldData.invalid) {

                            // Use a Set to track already displayed messages
                            var displayedMessages = new Set();

                            fieldData.invalid.forEach(function(entry) {
                                if (!displayedMessages.has(entry.message)) {
                                    var reasonMsg = "<p>" + entry.message + "</p>";
                                    $('#step_4_msg').append(reasonMsg);
                                    displayedMessages.add(entry.message); // Add message to set
                                }

                                var detailedMsg = "<p> - " + entry.value + " in row " + (entry.row + 2) + "</p>";
                                $('#step_4_msg').append(detailedMsg);
                            });

                            statusClass = 'text-danger';
                        }

                        if (fieldData && fieldData.empty_values && fieldData.empty_values.length > 0) {
                            var emptyRows = fieldData.empty_values.map(function(row) {
                                return row + 2; // Adjust row number by 2 (header + zero-indexing)
                            });
                            var emptyMsg = "<p>Empty values for field " + fieldName + " in rows: " + emptyRows.join(", ") + "</p>";
                            $('#step_4_msg').append(emptyMsg);
                            statusClass = 'text-danger';
                        }
                        if (fieldData && fieldData.missing) {
                            var missingMsg = "<p>" + fieldData.message + "</p>";
                            $('#step_4_msg').append(missingMsg);
                            statusClass = 'text-danger';
                        }
                    }
                }

                var result = response['result'];
                // Dynamically handle all issues in response
                Object.keys(result).forEach(function(key) {
                    if (key !== 'status') {
                        handleIssues(key, result[key]);
                    }
                });

                var data = response['data'];
                var expectedColumns = response['expectedColumns'];

                // Generate table header
                var headerRow = '<tr>';
                headerRow += '<th class="bg-gray">DbID</th>';
                headerRow += '<th class="bg-gray"><span class="grey">____</span>Sequencer_IDs<span class="grey">____</span></th>';
                expectedColumns.forEach(function(column) {
                    var hasIssues = result[column] && result[column].missing;
                    headerRow += '<th' + (hasIssues ? ' class="text-danger"' : '') + '>' + column + '</th>';
                });
                headerRow += '</tr>';
                $('#dataTable thead').html(headerRow);

                data.forEach(function(row, rowIndex) {
                    var tableRow = '<tr>';
                    var latitudeValue = null;
                    var longitudeValue = null;
                    var latitudeValid = false;
                    var longitudeValid = false;
                    // Add the id if one was generated in the database.
                    // This only exists if all the data were correct and
                    // have been added
                    if (row["id"] == null) {
                      tableRow += '<td class="bg-gray">-</td>';
                    } else {
                      tableRow += '<td class="bg-gray">' + row['id'] + '</td>';
                    }

                    // Add the sequencersIDs if they have been added
                    // This only exists after step 6
                    if (row["sequencers"] == null) {
                      tableRow += '<td class="bg-gray">-</td>';
                    } else {
                      tableRow += '<td class="bg-gray">' + row['sequencers'] + '</td>';
                    }

                    expectedColumns.forEach(function(column) {
                        var cellValue = row[column];
                        if (cellValue !== undefined && cellValue !== null) {
                            cellValue = cellValue.toString();
                        } else {
                            cellValue = '';
                        }

                        // Check if this field had any problems
                        var hasIssues = result[column] && (result[column].invalid || result[column].empty_values);

                        // Check if this specific row has issues for the current column
                        var rowHasIssues = hasIssues && result[column].invalid && result[column].invalid.some(function(entry) {
                            return entry.row === rowIndex;
                        });

                        // Check if this row has empty values for the current column
                        var rowHasEmptyValues = hasIssues && result[column].empty_values && result[column].empty_values.includes(rowIndex);

                        // If it should not be empty but is and has issues for this row, show "MISSING" in red
                        if (rowHasEmptyValues) {
                            tableRow += '<td><span class="text-danger">MISSING</span></td>';
                        } else if (!cellValue && expectedColumns.includes(column) && rowHasIssues) {
                            tableRow += '<td><span class="text-danger">MISSING</span></td>';
                        } else {
                            // If there are issues for this row in this column, display the cell value in red
                            if (rowHasIssues) {
                                tableRow += '<td><span class="text-danger">' + cellValue + '</span></td>';
                            } else {
                                // Otherwise, display the cell value normally
                                tableRow += '<td>' + cellValue + '</td>';
                            }
                        }

                        // Extract latitude and longitude values
                        if (column === 'Latitude') {
                            latitudeValue = cellValue;
                            latitudeValid = !rowHasIssues && !rowHasEmptyValues && !isNaN(parseFloat(latitudeValue));
                        }
                        if (column === 'Longitude') {
                            longitudeValue = cellValue;
                            longitudeValid = !rowHasIssues && !rowHasEmptyValues && !isNaN(parseFloat(longitudeValue));
                        }
                    });
                    tableRow += '</tr>';
                    $('#dataTable tbody').append(tableRow);

                    // Add the sampleID as option to sequencer_sample_id
                    $('#sequencer_sample_id').append(
                        $('<option></option>').val(row['id']).text(row['SampleID'])
                    );
                    // Check if both latitude and longitude are valid
                    if (latitudeValid && longitudeValid && latitudeValue && longitudeValue) {
                        var location = { lat: parseFloat(latitudeValue), lng: parseFloat(longitudeValue) };
                        if (!isNaN(location.lat) && !isNaN(location.lng)) {
                            var marker = new google.maps.marker.AdvancedMarkerElement({
                                position: location,
                                map: map
                            });
                            markersArray.push(marker); // Store marker in array
                            bounds.extend(location); // Extend the bounds to include this marker
                        } else {
                            console.error("Invalid latitude or longitude values.");
                        }
                    }
                });

                // Adjust the map's viewport to fit all markers
                if (markersArray.length > 0) {
                    map.fitBounds(bounds);

                    // Optionally, set a minimum zoom level
                    var maxZoom = 14;
                    var listener = google.maps.event.addListener(map, "idle", function() {
                        if (map.getZoom() > maxZoom) map.setZoom(maxZoom);
                        google.maps.event.removeListener(listener);
                    });

                    $('#mapCheckMessage').html("<h4>Please check the map to make sure all your coordinates are in the places where your samples were collected.</h4>");
                }

                // Show success message if no issues found
                if (response.result.status === 1) {
                    $('#step_4_msg').append("<p>No problems found.</p>");
                    enableForm_step_5();
                }

                // Check if there are any messages and display them
                if (response.result.messages && response.result.messages.length > 0) {
                    response.result.messages.forEach(function(message) {
                        $('#step_4_msg').append("<p>" + message + "</p>");
                    });
                }

                // Apply the appropriate status class
                $('#step_4_msg').addClass(statusClass);

                // Reset the file input
                fileInput.value = "";
            },
            error: function(xhr, status, error) {
                console.error('Error:', error);
                $('#step_4_msg').html("<p>An error occurred while processing the file.</p>").removeClass('text-success').addClass('text-danger');

                // Reset the file input
                fileInput.value = "";
            }
        });
    }

  });
  ////// ############################################# /////////
  ////// ####### STEP 4 UPLOAD FILE ENDS HERE ###### /////////
  ////// ############################################# /////////

  ////// ############################################# /////////
  ////// ###### STEP 4 FILL IN FORM STARTS HERE ###### /////////
  ////// ############################################# /////////
  $(document).ready(function() {
    // Clear error messages when user starts typing or selects an option
    $('#metadataForm :input').on('input change', function() {
        $(this).closest('.form-group').find('.error-message').remove();
    });

    // Submit form event handler
    $('#metadataForm').submit(function(event) {
        event.preventDefault(); // Prevent default form submission

        // Function to clear all error messages
        function clearErrors() {
            $('.error-message').remove();
        }

        function formatDateToDDMMYYYY(dateString) {
            const [year, month, day] = dateString.split("-");
            return `${day}/${month}/${year}`;
        }

        // Function to display error message
        function showError(input, message) {
            var errorElement = $(input).closest('.form-group').find('.error-message');
            if (errorElement.length === 0) {
                errorElement = $('<small class="form-text text-danger error-message"></small>');
                $(input).closest('.form-group').append(errorElement);
            }
            errorElement.text(message).show();
        }

        clearErrors(); // Clear existing error messages

        var formData = $(this).serializeArray();
        // Convert date fields to DD/MM/YYYY format
        formData.forEach(field => {
            // Find the corresponding input element
            var inputElement = $(`[name="${field.name}"]`);

            // Check if the input element is of type 'date'
            if (inputElement.attr('type') === 'date') {
                field.value = formatDateToDDMMYYYY(field.value);
            }
        });

        // Serialize the formData back to a URL-encoded string
        var serializedData = $.param(formData);

        // Send the form fields via AJAX to metadata_validate_row
        $.ajax({
            url: '/metadata_validate_row', // Adjust URL as needed
            type: 'POST',
            data: formData,
            dataType: 'json',
            success: function(response) {
              if (response.result.status === 0) {
                  Object.keys(response.result).forEach(field => {
                      if (field !== 'status') {
                          var fieldResult = response.result[field];
                          if (fieldResult.empty_values || fieldResult.invalid) {
                              var inputElement = $(`[name="${field}"]`);
                              inputElement.addClass('error');

                              var errorMessage = fieldResult.message;
                              if (fieldResult.invalid && fieldResult.invalid.length > 0) {
                                  errorMessage += ': ' + fieldResult.invalid[0].message;
                              }

                              inputElement.after(`<div class="text-danger error-message">${errorMessage}</div>`);
                          }
                      }
                  });
              } else {
                  // Extract latitude and longitude values if valid
                  var latitudeValue = '';
                  var longitudeValue = '';
                  formData.forEach(field => {
                      if (field.name === 'Latitude') latitudeValue = field.value;
                      if (field.name === 'Longitude') longitudeValue = field.value;
                  });

                  // Add marker if latitude and longitude are valid
                  if (latitudeValue && longitudeValue) {
                      addMarker(latitudeValue, longitudeValue);
                  }
                  console.log('Form submitted successfully');
              }
            },
            error: function(xhr, status, error) {
                $('#form_message').text('An error occurred. Please try again later.').addClass('text-danger').removeClass('text-success text-info').show();
            }
        });
    });

  });
  ////// ############################################# /////////
  ////// ####### STEP 4 FILL IN FORM ENDS HERE ####### /////////
  ////// ############################################# /////////

  ////// ############################################# /////////
  ////// ############ STEP 5 STARTS HERE ############# /////////
  ////// ############################################# /////////
  function enableForm_step_5() {
      $('#step_5_form fieldset').removeAttr('disabled');
  }
  $(document).ready(function() {
    $('#step_5_button').click(function() {

      var formData = new FormData();
      var form = $('#step_5_button').closest('form');
      var processId = form.find('input[name="process_id"]').val();
      formData.append('process_id', processId);

      $.ajax({
          url: '/sequencing_confirm_metadata',
          type: 'POST',
          data: formData,
          contentType: false,
          processData: false,
          success: function(response) {
              console.log(response);
              if (response.result==1) {
                window.location.reload();
              }
          },
          error: function(xhr, status, error) {
              console.error('Error:', error);
              $('#step_5_msg').html("<p>An error occurred.</p>").removeClass('text-success').addClass('text-danger');

              // Reset the file input
              fileInput.value = "";
          }
      });

      enableForm_step_6();
    });
  });
  ////// ############################################# /////////
  ////// ############ STEP 5 ENDS HERE ############### /////////
  ////// ############################################# /////////

  ////// ############################################# /////////
  ////// ############ STEP 6 STARTS HERE ############# /////////
  ////// ############################################# /////////
  function enableForm_step_6() {
      $('#step_6_form fieldset').removeAttr('disabled');
  }
  function disableForm_step_6() {
      $('#step_6_form fieldset').attr('disabled', 'disabled');
  }
  function update_step6_sample_ids_dropdown_options(missingSequencingIds) {
    var dropdownOptions = '<option value="0">------</option>';

    if (missingSequencingIds && missingSequencingIds.length > 0) {
        // Loop through the samples_data to find missing IDs
        samples_data.forEach(function(row) {
            if (missingSequencingIds.includes(row.id)) {
                dropdownOptions += '<option value="' + row.id + '">' + row.SampleID + '</option>';
            }
        });

        // Update the dropdown and enable it
        $('#sequencer_sample_id').html(dropdownOptions);
        $('#sequencer_sample_id').prop('disabled', false);
    } else {
        // If no missing IDs, reset and disable the dropdown
        $('#sequencer_sample_id').html('<option value="0">------</option>');
        $('#sequencer_sample_id').prop('disabled', true);
    }
  }
  
  $(document).ready(function() {

    // Listen for changes in the radio buttons using_scripps
    ////// Choose upload method (form or file) ///////
    $('input[name="upload_sequencerids_method"]').change(function() {
      console.log('here');
      if (this.value == '1') {
        $('#step_6_case_1').show();
        $('#step_6_case_2').hide();
        $('#sequencerIdsForm').hide();
      } else if (this.value == '2') {
        $('#step_6_case_1').hide();
        $('#step_6_case_2').show();
        $('#sequencerIdsForm').show();
      }
    });

    // Submit form event handler
    $('#sequencerIdsForm').submit(function(event) {
        event.preventDefault(); // Prevent default form submission

        var formData = $(this).serializeArray();
        var sequencerSampleId = null;
        var sequencerRegion = null;
        var sequencerId = null;
        var index_1 = null;
        var index_2 = null;

        // Extract values from formData
        formData.forEach(function(item) {
            if (item.name === 'sequencer_sample_id') {
                sequencerSampleId = item.value;
            } else if (item.name === 'sequencer_region') {
                sequencerRegion = item.value;
            } else if (item.name === 'sequencer_id') {
                sequencerId = item.value;
            } else if (item.name === 'index_1') {
                index_1 = item.value;
            } else if (item.name === 'index_2') {
                index_2 = item.value;
            }
        });

        console.log(formData)
        if ((sequencerId != null) && (sequencerId != '') && (sequencerRegion != '')) {

          // Send the form fields via AJAX to metadata_validate_row
          $.ajax({
              url: '/add_sequencer_id', // Adjust URL as needed
              type: 'POST',
              data: formData,
              success: function(response) {
                  if (response.result.status === 0) {
                      console.log('There was an error');
                  } else {
                      console.log(response)
                      if (response.existing == "new") {
                        // Find the table row that matches the sequencerSampleId
                        $('#dataTable tbody tr').each(function() {
                            var rowId = $(this).find('td:first').text().trim();
                            if (rowId === sequencerSampleId) {
                                // Update the second cell in the matched row
                                var cell = $(this).find('td').eq(1);
                                cell.append(' ' + sequencerRegion + ' : ' + sequencerId + '<br/>');
                            }
                        });

                        //find the id of the table cell for the sequence and the region.
                        var s_td_id = ''
                        var r_td_id = ''
                        for (let i = 1; i <= sequencing_regions_number; i++) {
                          s_td_id = '#S_' + sequencerSampleId + '_' + String(i)
                          if ($(s_td_id).html().trim() === '') {
                            $(s_td_id).html(sequencerId)
                            // Since we found the empty td, lets update the rest of its row data
                            r_td_id = '#R_' + sequencerSampleId + '_' + String(i)
                            $(r_td_id).html(sequencerRegion)
                            i1_td_id = '#I1_' + sequencerSampleId + '_' + String(i)
                            if (index_1) {
                              $(i1_td_id).html(index_1)
                            } else {
                              $(i1_td_id).html('None')
                            }
                            i2_td_id = '#I2_' + sequencerSampleId + '_' + String(i)
                            if (index_2) {
                              $(i2_td_id).html(index_2)
                            } else {
                              $(i2_td_id).html('None')
                            }                                                   
                          }
                        }

                        $('#sequencerIdsForm_message').text('Record added above in the metadata table. Fill in the form to add new record.').addClass('text-success').removeClass('text-danger text-info').show();
                      } else {
                        $('#sequencerIdsForm_message').text('Record already exists for this sample and region. Fill in the form to add new record.').addClass('text-danger').removeClass('text-success').show();
                      }
                      $('#sequencerIdsForm').trigger('reset');
                      
                      //console.log('The samples_data is ')
                      //console.log(samples_data)
                      if (response.missing_sequencing_ids) {
                        update_step6_sample_ids_dropdown_options(response.missing_sequencing_ids)
                        update_step7_missing_ids_div(response.missing_sequencing_ids)
                      }
                  }
              },
              error: function(xhr, status, error) {
                  $('#sequencerIdsForm_message').text('An error occurred. Please try again later.').addClass('text-danger').removeClass('text-success text-info').show();
              }
          });
        } else {
          $('#sequencerIdsForm_message').text('Please fill in all the required data.').addClass('text-danger').removeClass('text-success text-info').show();
        }
    });

    $('#step_6_file_upload_button').on('change', function () {
      var fileInput = $('#step_6_file_upload_button')[0];
      var file = fileInput.files[0];

      if (file) {
          var fileName = file.name;
          $('#step_6_filename').html("<h4>File uploaded: " + fileName + "</h4>");
      }

      if (!file) {
          alert("Please select a file.");
          return;
      }

      var formData = new FormData();
      formData.append('file', file);

      var form = $('#step_6_file_upload_button').closest('form');
      var processId = form.find('input[name="process_id"]').val();
      formData.append('process_id', processId);


      $.ajax({
          url: '/upload_sequencer_ids_file',
          type: 'POST',
          data: formData,
          contentType: false,
          processData: false,
          success: function(response) {
              console.log(response);
              $('#step_6_msg').html('').removeClass('text-danger text-success');
              // Reset the file input
              fileInput.value = "";
              if (response.result == 0) {
                  response.messages.forEach(function(message) {
                      // Create a new paragraph element for each message
                      $('<p></p>')
                          .text(message)
                          .removeClass('text-success')
                          .addClass('text-danger')
                          .appendTo('#step_6_msg');
                  });
              } else {
                response.data.forEach(function(sequencer_id) {

                  sequencerSampleId = sequencer_id["db_sample_id"]
                  $('#dataTable tbody tr').each(function() {
                      var rowId = $(this).find('td:first').text().trim();
                      if (String(rowId) === String(sequencerSampleId)) {
                          sequencerRegion = sequencer_id["Region"]
                          sequencerId = sequencer_id["SequencerID"]
                          // Update the second cell in the matched row
                          var cell = $(this).find('td').eq(1);
                          cell.append(' ' + sequencerRegion + ' : ' + sequencerId + '<br/>');
                      }
                  });
                  // HERE HERE
                  // Find the element S_ row id _1
                  if ($('#S_' + sequencerSampleId + '_1').html().trim() === '') {
                    $('#S_' + sequencerSampleId + '_1').html(sequencer_id["SequencerID"])
                    $('#R_' + sequencerSampleId + '_1').html(sequencer_id["Region"])
                    $('#I1_' + sequencerSampleId + '_1').html(sequencer_id["Index_1"])
                    $('#I2_' + sequencerSampleId + '_1').html(sequencer_id["Index_2"])
                  } else if ($('#S_' + sequencerSampleId + '_2').html().trim()=='') {
                    $('#S_' + sequencerSampleId + '_2').html(sequencer_id["SequencerID"])
                    $('#R_' + sequencerSampleId + '_2').html(sequencer_id["Region"])
                    $('#I1_' + sequencerSampleId + '_2').html(sequencer_id["Index_1"])
                    $('#I2_' + sequencerSampleId + '_2').html(sequencer_id["Index_2"])
                  }

                })


                // Clear previous messages and reset status class
                $('#step_6_msg').html('File uploaded successfully. Records added to the metadata table above').addClass('text-success');
                //enableForm_step_8()
                if (response.missing_sequencing_ids) {
                  update_step6_sample_ids_dropdown_options(response.missing_sequencing_ids)
                  update_step7_missing_ids_div(response.missing_sequencing_ids)
                }                
              }
          },
          error: function(xhr, status, error) {
              console.error('Error:', error);
              $('#step_6_msg').html("<p>An error occurred while processing the file.</p>").removeClass('text-success').addClass('text-danger');

              // Reset the file input
              fileInput.value = "";
          }
      });
    });


  });
  ////// ############################################# /////////
  ////// ############ STEP 6 ENDS HERE ############### /////////
  ////// ############################################# /////////

  ////// ############################################# /////////
  ////// ############ STEP 7 STARTS HERE ############# /////////
  ////// ############################################# /////////
  function enableForm_step_7() {
      $('#step_7_form fieldset').removeAttr('disabled');
  }
  function disableForm_step_7() {
      $('#step_7_form fieldset').attr('disabled', 'disabled');
  }   
  function update_step7_missing_ids_div(missingSequencingIds) {
      if (missingSequencingIds && missingSequencingIds.length > 0) {
          var newContent = '<h4>The following samples are missing one or more of their expected regions</h4>';
          newContent += '<ul>';

          // Loop through the samples_data to find missing IDs
          samples_data.forEach(function(row) {
              if (missingSequencingIds.includes(row.id)) {
                  newContent += '<li>' + row.SampleID + '</li>';
              }
          });

          newContent += '</ul>';

          // Replace the content of the #step_7_missing_ids div
          $('#step_7_missing_ids').html(newContent);
      } else {
          // If no missing IDs, clear the div
          $('#step_7_missing_ids').empty();
      }
  }
  $(document).ready(function() {
    $('#step_7_button').click(function() {
      enableForm_step_8();
      disableForm_step_6();
      disableForm_step_7();
    });
  });  
  ////// ############################################# /////////
  ////// ############ STEP 7 ENDS HERE ############### /////////
  ////// ############################################# /////////

  ////// ############################################# /////////
  ////// ############ STEP 8 STARTS HERE ############# /////////
  ////// ############################################# /////////
  {% if process_data and not process_data.using_scripps %}
    function enableForm_step_8() {
        $('#step_8_form fieldset').removeAttr('disabled');
    }

    function updateTableCell(file_name, sequencerId) {
        var cellIdA = '#F_' + sequencerId + '_A';
        var cellIdB = '#F_' + sequencerId + '_B';

        // Update the first cell if needed
        var cellA = $(cellIdA);
        if (cellA.find('span.red').length > 0) {
            cellA.html(file_name); // Replace with file_name
            return; // Exit function after updating the first cell
        }

        // If the first cell is not empty, then update the second cell
        var cellB = $(cellIdB);
        if (cellB.find('span.red').length > 0) {
            cellB.html(file_name); // Replace with file_name
        }
    }

    function setUpResumable() {
        var step_8_form = $('#step_8_upload_file_button').closest('form');
        var process_id = step_8_form.find('input[name="process_id"]').val();
        var allowedExtensions = ['gz']; // Define allowed file extensions
        var commonOptions = {
            target: '/sequencing_upload_chunk',
            chunkSize: 10 * 1024 * 1024,
            testChunks: true,
            uploadMethod: 'POST',
            fileType: allowedExtensions,
            fileTypeErrorCallback: function(file, errorCount) {
                var fileExtension = file.name.split('.').pop().toLowerCase();
                if (!allowedExtensions.includes(fileExtension)) {
                    alert('File type not allowed! Please select a .gz file.');
                    return false; // Cancel the file upload
                }
            },
        };

        var r = new Resumable(commonOptions);

        r.on('filesAdded', function(files) {
            files.forEach(function(file) {
                var file_msg_id = 'step_8_file_' + file.uniqueIdentifier;
                var file_name = file.file.name;

                // Add a div for each file
                var file_row = '<div id="' + file_msg_id + '"><h4>' + file_name + '</h4></div>';
                $('#step_8_msg').append(file_row);

                var formData = new FormData();
                formData.append('process_id', process_id);
                formData.append('filename', file_name);

                $.ajax({
                    url: '/check_filename_matching',
                    type: 'POST',
                    data: formData,
                    contentType: false,
                    processData: false,
                    success: function(response) {
                        console.log(response);

                        if (response.result === 1) {
                            if (response.matching_sequencer_id) {
                                var matchingSequencerIds = response.matching_sequencer_id;
                                $("#" + file_msg_id).append("<p>No problems found.</p>").addClass('text-success');

                                // Calculate MD5 and start upload
                                calculateMD5(file.file, function(md5) {
                                    // Set unique query parameters for this file
                                    file.opts = {
                                        query: {
                                            process_id: process_id,
                                            filename: file_name,
                                            filesize: file.file.size,
                                            filechunks: Math.ceil(file.file.size / r.opts.chunkSize),
                                            fileindex: file.uniqueIdentifier,
                                            sequencerId: matchingSequencerIds,
                                            md5: md5
                                        }
                                    };
                                    console.log(file.opts)
                                    $("#" + file_msg_id).append('Md5 for file ' + file_name + ' calculated: ' + md5)
                                        .addClass('text-info').removeClass('text-danger').removeClass('text-success');

                                    console.log('We will now try to upload the file');
                                    r.upload(); // Start the upload
                                }, function(progress) {
                                    $("#" + file_msg_id).html('Calculating md5 for file ' + file_name + '. Progress: ' + progress.toFixed(2) + '%')
                                        .addClass('text-info').removeClass('text-danger').removeClass('text-success');
                                });
                            } else {
                                $("#" + file_msg_id).append("<p>" + response.message + "</p>")
                                    .removeClass('text-success').addClass('text-danger');
                            }
                        } else {
                            $("#" + file_msg_id).append("<p>" + response.message + "</p>")
                                .removeClass('text-success').addClass('text-danger');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error:', error);
                        $("#" + file_msg_id).html("<p>An error occurred while processing the file.</p>")
                            .removeClass('text-success').addClass('text-danger');
                    }
                });
            });

            var fileInput = $('#step_8_upload_file_button')[0];
            fileInput.value = "";
        });

        r.assignBrowse(document.getElementById('step_8_upload_file_button'));

        r.on('fileSuccess', function(file, message) {
            var file_msg_id = 'step_8_file_' + file.uniqueIdentifier;
            console.log('File upload success', message);
            var file_name = file.file.name;
            var formData = new FormData();

            // Ensure process_id is defined and accessible
            if (typeof process_id === 'undefined' || !process_id) {
                console.error('process_id is not defined.');
                return;
            }

            formData.append('process_id', process_id);
            formData.append('filename', file_name);
            formData.append('fileopts', JSON.stringify(file.opts.query));
            $.ajax({
                url: '/sequencing_file_upload_completed',
                type: 'POST',
                data: formData,
                contentType: false,
                processData: false,
                success: function(response) {
                    console.log(response);

                    if (response.result === 1) {
                      $("#" + file_msg_id).append("<p>Upload completed successfully.</p>").addClass('text-success');
                      console.log('we should put the file at ')
                      console.log(file.opts.query.sequencerId)
                      // Update the table cells
                      updateTableCell(file_name, file.opts.query.sequencerId);
                    } else {
                        $("#" + file_msg_id).append("<p>An error occurred. The file could not be joined. Please try again.</p>")
                            .removeClass('text-success').addClass('text-danger');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error:', error);
                    $("#" + file_msg_id).html("<p>An error occurred while processing the file.</p>")
                        .removeClass('text-success').addClass('text-danger');
                }
            });
        });

        r.on('fileError', function(file, message) {
            var file_msg_id = 'step_8_file_' + file.uniqueIdentifier;
            console.log('File upload error', message);
            $("#" + file_msg_id).append("<p>Upload failed.</p>").addClass('text-danger');
        });
    }
    function calculateMD5(file, callback, updateCallback) {
        var chunkSize = 2097152; // 2 MB chunks
        var spark = new SparkMD5.ArrayBuffer();
        var fileReader = new FileReader();
        var startTime = performance.now(); // Start timer
        var totalChunks = Math.ceil(file.size / chunkSize);
        var chunksProcessed = 0;

        fileReader.onload = function (event) {
            spark.append(event.target.result); // Append chunk to MD5 calculation
            chunksProcessed++;
            if (chunksProcessed < totalChunks) {
                loadNext();
            } else {
                var endTime = performance.now(); // End timer
                var duration = endTime - startTime; // Calculate duration
                console.log('MD5 calculated in ' + duration.toFixed(2) + ' milliseconds'); // Log duration
                callback(spark.end());
            }
            updateCallback((chunksProcessed / totalChunks) * 100); // Update progress
        };

        fileReader.onerror = function () {
            console.warn('Error reading file');
            callback(null);
        };

        function loadNext() {
            var start = fileReader.loaded || 0;
            var end = Math.min(start + chunkSize, file.size);
            fileReader.readAsArrayBuffer(file.slice(start, end));
            fileReader.loaded = end; // Update loaded bytes
        }

        loadNext();
    }
    $(document).ready(function() {

      setUpResumable()

      function uploadSequencingFile() {
          var fileInput = $('#step_8_upload_file_button')[0];
          var file = fileInput.files[0];
          var filename = '';

          if (file) {
              console.log('here here , the filename is')
              var fileName = file.name;
              console.log(fileName)
              $('#step_8_filename').html("<h4>File uploaded: " + fileName + "</h4>");
          } else {
              alert("Please select a file.");
              return;
          }


          var formData = new FormData();

          var form = $('#step_8_upload_file_button').closest('form');
          var processId = form.find('input[name="process_id"]').val();
          formData.append('process_id', processId);
          formData.append('filename', fileName);
          console.log(formData)
          console.log('Unique Identifier for file:', file.uniqueIdentifier);
          var file_msg_id = 'step_8_file_' + file.uniqueIdentifier;






      }

    });
  {% endif %}
  ////// ############################################# /////////
  ////// ############ STEP 8 ENDS HERE ############### /////////
  ////// ############################################# /////////



  ////// ############################################# /////////
  ////// ###### MAP HELPER FUNCTIONS START HERE ###### /////////
  ////// ############################################# /////////
  function addMarker(lat, lng) {
      var location = { lat: parseFloat(lat), lng: parseFloat(lng) };
      if (!isNaN(location.lat) && !isNaN(location.lng)) {
          var marker = new google.maps.marker.AdvancedMarkerElement({
              position: location,
              map: map
          });
          //var bounds = new google.maps.LatLngBounds();
          markersArray.push(marker);
          bounds.extend(location);
          map.fitBounds(bounds);

          var maxZoom = 14;
          var listener = google.maps.event.addListener(map, "idle", function () {
              if (map.getZoom() > maxZoom) map.setZoom(maxZoom);
              google.maps.event.removeListener(listener);
          });
      } else {
          console.error("Invalid latitude or longitude values.");
      }
  }

  $(document).ready(function() {
    $('#latitude, #longitude').on('input', function() {
        var latitudeValue = $('#latitude').val().trim();
        var longitudeValue = $('#longitude').val().trim();

        // Regular expressions to match latitude and longitude in WGS1984 format
        var latitudePattern = /^[-+]?([1-8]?\d(\.\d+)?|90(\.0+)?)$/;
        var longitudePattern = /^[-+]?([1-9]?\d(\.\d+)?|1[0-7]\d(\.\d+)?|180(\.0+)?)$/;

        var latitudeValid = latitudePattern.test(latitudeValue);
        var longitudeValid = longitudePattern.test(longitudeValue);

        // Update help text and styles for latitude input
        if (!latitudeValid) {
            $('#latitudeHelp').text('Please enter a valid latitude in the WGS1984 format. Ideally in decimal format.').addClass('text-danger');
        } else {
            $('#latitudeHelp').text('Latitude of coordinates measured using WGS1984 (default on most GPS). Ideally in decimal format').removeClass('text-danger');
        }

        // Update help text and styles for longitude input
        if (!longitudeValid) {
            $('#longitudeHelp').text('Please enter a valid longitude in the WGS1984 format. Ideally in decimal format.').addClass('text-danger');
        } else {
            $('#longitudeHelp').text('Longitude of coordinates measured using WGS1984 (default on most GPS). Ideally in decimal format').removeClass('text-danger');
        }

        // Check if both latitude and longitude are valid
        if (latitudeValid && longitudeValid) {
            // Refresh the map and show marker at the specified coordinates
            var location = { lat: parseFloat(latitudeValue), lng: parseFloat(longitudeValue) };
            map.panTo(location);
            map.setZoom(14); // Set higher zoom level
            if (marker) {
                marker.position = location;
            } else {
              console.log(location);
                marker = new google.maps.marker.AdvancedMarkerElement({
                    position: location,
                    map: map
                });
            }
        }
    });

    // Check if fields with the names "Latitude" and "Longitude" exist in each row
    // and if they exist, call the function bellow with those values
    // addMarker(longitude, latitude)
    // Iterate over each row in the samples_data
    samples_data.forEach(function(row) {
      // Check if both "Latitude" and "Longitude" fields exist
      if (row.hasOwnProperty('Latitude') && row.hasOwnProperty('Longitude')) {
        // Call addMarker with the values
        addMarker(row['Latitude'], row['Longitude']);
      }
    });

  });

  let map;
  let bounds = new google.maps.LatLngBounds();;

  async function initMap() {
    const { Map } = await google.maps.importLibrary("maps");
    const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");

    map = new Map(document.getElementById("map"), {
      center: { lat: -34.397, lng: 150.644 },
      zoom: 8,
      mapId: "SEQ_SAMPLE_POSITION",
    });
  }

  initMap();
  ////// ############################################# /////////
  ////// ###### MAP HELPER FUNCTIONS END HERE ######## /////////
  ////// ############################################# /////////

  </script>

  <style>
    #map {
      height: 100%;
    }
    #mapWrapper {
      padding-top: 2rem;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #mapWrapper {
      height: 350px;
      width: 700px;
    }

    .table-container {
        overflow-x: auto; /* Enable horizontal scrolling */
    }

    .blue {
      color: blue;
    }
    .red {
      color: red;
    }
    .green {
      color: green;
    }
    .orange {
      color: orange;
    }
    .grey {
      color: #cac7c7;
    }
    .bg-gray {
      background-color: #cac7c7;
    }
    #dataTable {
        table-layout: auto;
    }

    #step_6-container {
      display: flex;
    }

    #step_6 {
        flex: 1;
    }

    #next_to_step_6 {
        flex: 1;
        margin-left: 20px; /* Adjust margin as needed */
        margin-top: 20px;
    }
  </style>
</body>
</html>
