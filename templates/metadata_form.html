<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="/static/css/general.css" rel="stylesheet" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" integrity="sha512-jnSuA4Ss2PkkikSOLtYs8BlYIeeIK1h99ty4YfvRPAlzr377vr3CXDb7sb7eEEBYjDtcYj+AjBH3FLv5uSJuXg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js" integrity="sha512-7Pi/otdlbbCR+LnW+F7PwFcSDJOuUJB3OxtEHbg4vSMvzvJjde4Po1v4BR9Gdc9aXNUNFVUY+SK51wWT8WF0Gg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAw6r8DeUDlEO8iZdnMmPSkzWUmIYbbOPY&libraries=marker"></script>

    <title>Upload data</title>
</head>
<body>
  <div class="app-navbar">
    <a href="https://spun.earth" class="logo"></a>
    <div class="menu">
      <ul>
        <li><a href="https://spun.earth">Spun Website</a></li>
        <li><a href="/">App homepage</a></li>
        <li><a href="/logout">Logout</a></li>
      </ul>
    </div>
  </div>
  <div class="content" style="p-4">
    <h1> Metadata Submission Form </h1>
    <div id="msg" class="text-info">{{ msg }}</div>

    <div id="form_reporting">
      {% if form_reporting %}
        {% for data in form_reporting %}
          <div class="text-info">{{ data }}</div>
        {% endfor %}
      {% endif %}
    </div>

    <div id="step_1" class="form-step-item">
      <h3> Step 1: Project ID allocated to user </h3>
        {% if my_buckets|length == 0 %}
          <div>You have no assigned project. Please contact the program coordinator</div>
        {% elif my_buckets|length == 1 %}
          <div>
            <p>The only assigned project for this user is {{ my_buckets|list|first }}. If the data are for this project, proceed.</p>
            <p>If you believe your data should be in a different project, please stop the process and contact the program coordinator</p>
          </div>
          <input type="hidden" id="assigned-project-id" value="{{ my_buckets|list|first }}"/>
        {% else %}
          <div>
            <label for="bucket-select">Select your project:</label>
            <select id="bucket-select" name="bucket">
              <option value="0">------</option>
              {% for bucket_name in my_buckets %}
                <option value="{{ bucket_name }}">{{ bucket_name }}</option>
              {% endfor %}
            </select>
            <p>If you you dont see your assigned project in the list, please stop the process and contact the program coordinator</p>
          </div>
        {% endif %}
    </div>

    <div id="step_2" class="form-step-item">
      <h3> Step 2: Select how you are going to give us the metadata</h3>
      <div>You can give us the metadata either by </div>
      <form id="step_2_form">
        <div class="form-check">
          <input class="form-check-input" type="radio" name="upload_method" id="upload_method_1" value="1">
          <label class="form-check-label" for="sequencing_method_1">
            Uploading a file of the format .xls or .csv
          </label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="radio" name="upload_method" id="upload_method_2" value="2">
          <label class="form-check-label" for="sequencing_method_2">
            Filling in the form once for each of your samples
          </label>
        </div>
      </form>
      <div id="step_2_explanation_case_1" class="explanation" style="display:none;">
        <p>You have to upload a csv or xls file that the column names EXACTLY as they appear bellow. </p>
        <p>You can read the <a href="/metadata_fields_explanation" class="link" target="_blank">description of each field here TODO</a></p>
        <p>You can download the <a href="/metadata_xls_template" class="link" target="_blank">XLS template TODO</a></p>
        <p>Or the <a href="/metadata_csv_template" class="link" target="_blank">CSV template TODO</a></p>
        <form
            method="POST"
            action="/upload_metadata_file"
            enctype="multipart/form-data"
            id="step_2_file_upload"
        >
          <input type="hidden" name="project_id" value="{{ project_id }}">
          <input type="file" id="step_2_file_upload_button" accept=".csv, .xls, .xlsx">
        </form>
      </div>
      <div id="step_2_explanation_case_2" class="explanation" style="display:none;">
        <p>Fill in the form bellow once for each sample. Pay very good attention to the coordinates.</p>
        <p>When you enter the coordinates the map should be showing you where this was.</p>
      </div>
      <div id="step_2_msg" class="explanation">

      </div>
    </div>

    <div class="table-container">
      <table id="dataTable" class="table-bordered">
        <thead>
          <tr>
            {% for expectedColumn in expected_columns.keys() %}
              <th scope="col">{{ expectedColumn }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

    </div>

    <div class="container">
      <div id="mapWrapper">
        <div id="map"></div>
      </div>
      <form id="metadataForm" style="display:none">
        {% for column_key, column_values in expected_columns.items() %}
            <div class="form-group row mb-3">
                <label for="{{ column_key }}" class="col-sm-3 col-form-label">{{ column_key }}</label>
                <div class="col-sm-9">
                    <small id="{{ column_key }}Help" class="form-text">{{ column_values['help_tip'] }}</small>
                    {% if 'options' in column_values %}
                        <select class="form-control" id="{{ column_key }}" name="{{ column_key }}">
                            <option value="0">------</option>
                            {% for option in column_values['options'] %}
                                <option value="{{ option }}">{{ option }}</option>
                            {% endfor %}
                        </select>
                    {% elif column_values.get('field_type') == 'date' %}
                        <input type="date" class="form-control" id="{{ column_key }}" name="{{ column_key }}">
                    {% else %}
                        <input type="text" class="form-control" id="{{ column_key }}" name="{{ column_key }}" placeholder="{{ column_key }}">
                    {% endif %}
                </div>
            </div>
        {% endfor %}
<h1> here here </h1>

        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>
    <div id="step_1_msg"></div>

  </div>

  <script type="application/javascript">
  let marker;
  $(document).ready(function() {
    $('input[name="upload_method"]').change(function() {
      if (this.value == '1') {
        $('#step_2_explanation_case_1').show();
        $('#step_2_explanation_case_2').hide();
        $('#metadataForm').hide();
      } else if (this.value == '2') {
        $('#step_2_explanation_case_1').hide();
        $('#step_2_explanation_case_2').show();
        $('#metadataForm').show();
      }
    });

    $('#sampleID').on('input', function() {
      console.log('Input event triggered');
      var sampleIDValue = $(this).val();
      console.log('Sample ID value:', sampleIDValue);
      var sampleIDPattern = /^[a-zA-Z]+[0-9]{2}_[0-9]+$/;

      if (!sampleIDPattern.test(sampleIDValue)) {
        console.log('Invalid Sample ID');
        $('#sampleIDHelp').text('Please enter a valid Sample ID. This should be a location name used to describe where you sampled (country or region), the year, and a sample number. I.e Patagonia22_1').addClass('text-danger');
      } else {
        console.log('Valid Sample ID');
        $('#sampleIDHelp').text('Unique sample tracking ID for your project. This should be a location name used to describe where you sampled (country or region), the year, and a sample number. I.e Patagonia22_1').removeClass('text-danger');
      }
    });

    $('#latitude, #longitude').on('input', function() {
        var latitudeValue = $('#latitude').val().trim();
        var longitudeValue = $('#longitude').val().trim();

        // Regular expressions to match latitude and longitude in WGS1984 format
        var latitudePattern = /^[-+]?([1-8]?\d(\.\d+)?|90(\.0+)?)$/;
        var longitudePattern = /^[-+]?([1-9]?\d(\.\d+)?|1[0-7]\d(\.\d+)?|180(\.0+)?)$/;

        var latitudeValid = latitudePattern.test(latitudeValue);
        var longitudeValid = longitudePattern.test(longitudeValue);

        // Update help text and styles for latitude input
        if (!latitudeValid) {
            $('#latitudeHelp').text('Please enter a valid latitude in the WGS1984 format. Ideally in decimal format.').addClass('text-danger');
        } else {
            $('#latitudeHelp').text('Latitude of coordinates measured using WGS1984 (default on most GPS). Ideally in decimal format').removeClass('text-danger');
        }

        // Update help text and styles for longitude input
        if (!longitudeValid) {
            $('#longitudeHelp').text('Please enter a valid longitude in the WGS1984 format. Ideally in decimal format.').addClass('text-danger');
        } else {
            $('#longitudeHelp').text('Longitude of coordinates measured using WGS1984 (default on most GPS). Ideally in decimal format').removeClass('text-danger');
        }

        // Check if both latitude and longitude are valid
        if (latitudeValid && longitudeValid) {
            // Refresh the map and show marker at the specified coordinates
            var location = { lat: parseFloat(latitudeValue), lng: parseFloat(longitudeValue) };
            map.panTo(location);
            map.setZoom(14); // Set higher zoom level
            if (marker) {
                marker.position = location;
            } else {
              console.log(location);
                marker = new google.maps.marker.AdvancedMarkerElement({
                    position: location,
                    map: map
                });
            }
        }
    });

    // Function to validate form fields
    function validateForm() {
        // Implement your validation logic here
        // Return true if all fields are valid, false otherwise
        return true; // Placeholder, replace with actual validation logic
    }

    // Function to populate table with form data
    function populateTable() {
        // Extract data from form fields
        var formData = {
            sampleID: $('#sampleID').val(),
            projectSpecificID: $('#projectSpecificID').val(),
            siteName: $('#siteName').val(),
            latitude: $('#latitude').val(),
            longitude: $('#longitude').val(),
            country: $('#country').val(),
            vegetation: $('#vegetation').val(),
            landUse: $('#landUse').val(),
            ecosystem: $('#ecosystem').val(),
            gridSize: $('#gridSize').val(),
            soilDepth: $('#soilDepth').val(),
            transportRefrigeration: $('input[name="transportRefrigeration"]:checked').val(),
            drying: $('#drying').val(),
            extractionMethod: $('#extractionMethod').val(),
            dateCollected: $('#dateCollected').val(),
            dnaConcentration: $('#dnaConcentration').val(),
            dnaConcInstrument: $('#dnaConcInstrument').val(),
            sequencingPlatform: $('#sequencingPlatform').val(),
            sequencingFacility: $('#sequencingFacility').val(),
            elevation: $('#elevation').val(),
            sampleOrControl: $('input[name="sampleOrControl"]:checked').val(),
            primers: $('#primers').val(),
            expeditionLeader: $('#expeditionLeader').val(),
            collaborators: $('#collaborators').val(),
            sequencingRun: $('#sequencingRun').val(),
            notes: $('#notes').val(),

        };
        console.log(formData);

        // Construct table row HTML using form data
        var tableRow = '<tr>';
        for (var key in formData) {
            tableRow += '<td>' + formData[key] + '</td>';
        }
        tableRow += '</tr>';

        // Append table row to table body
        $('#dataTable tbody').append(tableRow);
    }

    // Submit form event handler
    $('#metadataForm').submit(function(event) {
        // Prevent default form submission
        event.preventDefault();

        // Validate form fields
        if (validateForm()) {
            // Populate table with form data
            populateTable();

            // Reset form fields
            $(this)[0].reset();

            // Submit form data to specified URL
            //$.post('/metadata_submit', $(this).serialize(), function(response) {
                // Handle response if needed
          //  });
        } else {
            // Handle case where form fields are not valid
            // You can display an error message or perform any other action here
        }
    });
  });

  $(document).ready(function () {
      $('#step_2_file_upload_button').on('change', function () {
          uploadFile();
      });
  });

  function uploadFile() {
      var fileInput = $('#step_2_file_upload_button')[0];
      var file = fileInput.files[0];

      if (!file) {
          alert("Please select a file.");
          return;
      }

      var formData = new FormData();
      formData.append('file', file);
      formData.append('project_id', 1);

      $.ajax({
          url: '/upload_metadata_file',
          type: 'POST',
          data: formData,
          contentType: false,
          processData: false,
          success: function(response) {
              console.log(response);

              // Clear previous messages and reset status class
              $('#step_2_msg').empty().removeClass('text-success text-danger');
              var statusClass = 'text-success';

              // Clear previous markers from the map
              if (window.markersArray) {
                  markersArray.forEach(function(marker) {
                      marker.setMap(null);
                  });
              } else {
                  window.markersArray = [];
              }

              var bounds = new google.maps.LatLngBounds();

              // Function to handle issues dynamically
              function handleIssues(fieldName, fieldData) {
                  if ((fieldData && fieldData.invalid) || (fieldData && fieldData.empty_values)) {
                      var issueMsg = "<h4>Problems with field " + fieldName + "</h4>";
                      $('#step_2_msg').append(issueMsg);
                      if (fieldData && fieldData.invalid) {
                          var issueMsg = "<p>" + fieldData.message + "</p>";
                          $('#step_2_msg').append(issueMsg);
                          fieldData.invalid.forEach(function(entry) {
                              var detailedMsg = "<p> - " + entry.value + " in row " + (entry.row + 2) + "</p>";
                              $('#step_2_msg').append(detailedMsg);
                          });
                          statusClass = 'text-danger';
                      }
                      if (fieldData && fieldData.empty_values && fieldData.empty_values.length > 0) {
                          var emptyRows = fieldData.empty_values.map(function(row) {
                              return row + 2; // Adjust row number by 2 (header + zero-indexing)
                          });
                          var emptyMsg = "<p>Empty values for field " + fieldName + " in rows: " + emptyRows.join(", ") + "</p>";
                          $('#step_2_msg').append(emptyMsg);
                          statusClass = 'text-danger';
                      }
                  }
              }

              var result = response['result'];
              // Dynamically handle all issues in response
              Object.keys(result).forEach(function(key) {
                  if (key !== 'status') {
                      handleIssues(key, result[key]);
                  }
              });

              var data = response['data'];
              var expectedColumns = response['expectedColumns'];

              data.forEach(function(row, rowIndex) {
                  var tableRow = '<tr>';
                  var latitudeValue = null;
                  var longitudeValue = null;
                  var latitudeValid = false;
                  var longitudeValid = false;

                  expectedColumns.forEach(function(column) {
                      var cellValue = row[column];
                      if (cellValue !== undefined && cellValue !== null) {
                          cellValue = cellValue.toString();
                      } else {
                          cellValue = '';
                      }

                      // Check if this field had any problems
                      var hasIssues = result[column] && (result[column].invalid || result[column].empty_values);

                      // Check if this specific row has issues for the current column
                      var rowHasIssues = hasIssues && result[column].invalid && result[column].invalid.some(function(entry) {
                          return entry.row === rowIndex;
                      });

                      // Check if this row has empty values for the current column
                      var rowHasEmptyValues = hasIssues && result[column].empty_values && result[column].empty_values.includes(rowIndex);

                      // If it should not be empty but is and has issues for this row, show "MISSING" in red
                      if (rowHasEmptyValues) {
                          tableRow += '<td><span class="text-danger">MISSING</span></td>';
                      } else if (!cellValue && expectedColumns.includes(column) && rowHasIssues) {
                          tableRow += '<td><span class="text-danger">MISSING</span></td>';
                      } else {
                          // If there are issues for this row in this column, display the cell value in red
                          if (rowHasIssues) {
                              tableRow += '<td><span class="text-danger">' + cellValue + '</span></td>';
                          } else {
                              // Otherwise, display the cell value normally
                              tableRow += '<td>' + cellValue + '</td>';
                          }
                      }

                      // Extract latitude and longitude values
                      if (column === 'Latitude') {
                          latitudeValue = cellValue;
                          latitudeValid = !rowHasIssues && !rowHasEmptyValues && !isNaN(parseFloat(latitudeValue));
                      }
                      if (column === 'Longitude') {
                          longitudeValue = cellValue;
                          longitudeValid = !rowHasIssues && !rowHasEmptyValues && !isNaN(parseFloat(longitudeValue));
                      }
                  });
                  tableRow += '</tr>';
                  $('#dataTable tbody').append(tableRow);

                  // Check if both latitude and longitude are valid
                  if (latitudeValid && longitudeValid && latitudeValue && longitudeValue) {
                      var location = { lat: parseFloat(latitudeValue), lng: parseFloat(longitudeValue) };
                      if (!isNaN(location.lat) && !isNaN(location.lng)) {
                          var marker = new google.maps.marker.AdvancedMarkerElement({
                              position: location,
                              map: map
                          });
                          markersArray.push(marker); // Store marker in array
                          bounds.extend(location); // Extend the bounds to include this marker
                      } else {
                          console.error("Invalid latitude or longitude values.");
                      }
                  }
              });

              // Adjust the map's viewport to fit all markers
              if (markersArray.length > 0) {
                  map.fitBounds(bounds);

                  // Optionally, set a minimum zoom level
                  var maxZoom = 14;
                  var listener = google.maps.event.addListener(map, "idle", function() {
                      if (map.getZoom() > maxZoom) map.setZoom(maxZoom);
                      google.maps.event.removeListener(listener);
                  });
              }

              // Show success message if no issues found
              if (response.status === 1 && Object.keys(result).length === 1) {
                  $('#step_2_msg').append("<p>No problems found.</p>");
              }

              // Apply the appropriate status class
              $('#step_2_msg').addClass(statusClass);
          },
          error: function(xhr, status, error) {
              console.error('Error:', error);
              $('#step_2_msg').html("<p>An error occurred while processing the file.</p>").removeClass('text-success').addClass('text-danger');
          }
      });
  }





  </script>


  <script>

    let map;

    async function initMap() {
      const { Map } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");

      map = new Map(document.getElementById("map"), {
        center: { lat: -34.397, lng: 150.644 },
        zoom: 8,
        mapId: "SEQ_SAMPLE_POSITION",
      });
    }

    initMap();
  </script>
  <style>
    #map {
      height: 100%;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #mapWrapper {
      height: 350px;
      width: 700px;
    }

    .table-container {
        overflow-x: auto; /* Enable horizontal scrolling */
    }

  </style>
</body>
</html>
