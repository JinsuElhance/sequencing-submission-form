<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link href="/static/css/general.css" rel="stylesheet" type="text/css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/css/bootstrap.min.css" integrity="sha512-jnSuA4Ss2PkkikSOLtYs8BlYIeeIK1h99ty4YfvRPAlzr377vr3CXDb7sb7eEEBYjDtcYj+AjBH3FLv5uSJuXg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js" integrity="sha512-7Pi/otdlbbCR+LnW+F7PwFcSDJOuUJB3OxtEHbg4vSMvzvJjde4Po1v4BR9Gdc9aXNUNFVUY+SK51wWT8WF0Gg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAw6r8DeUDlEO8iZdnMmPSkzWUmIYbbOPY&libraries=marker"></script>

    <title>Upload data</title>
</head>
<body>
  <div class="app-navbar">
    <a href="https://spun.earth" class="logo"></a>
    <div class="menu">
      <ul>
        <li><a href="https://spun.earth">Spun Website</a></li>
        <li><a href="/">App homepage</a></li>
        <li><a href="/logout">Logout</a></li>
      </ul>
    </div>
  </div>
  <div class="content" style="p-4">
    <h1> Metadata Submission Form </h1>
    <div id="msg" class="text-info">{{ msg }}</div>

    <div id="form_reporting">
      {% if form_reporting %}
        {% for data in form_reporting %}
          <div class="text-info">{{ data }}</div>
        {% endfor %}
      {% endif %}
    </div>

    <div id="step_1" class="form-step-item">
      <h3> Step 1: Project ID allocated to user </h3>
      <form id="step_1_form">
        <fieldset>
        {% if my_buckets|length == 0 %}
          <div>You have no assigned project. Please contact the program coordinator</div>
        {% elif my_buckets|length == 1 %}
          <div>
            <p>The only assigned project for this user is {{ my_buckets|list|first }}. If the data are for this project, proceed.</p>
            <p>If you believe your data should be in a different project, please stop the process and contact the program coordinator</p>
          </div>
          <input type="hidden" id="sequence-project-id" value="{{ my_buckets|list|first }}"/>
        {% else %}
          <div>
            <label for="sequence-project-id">Select your project:</label>
            <select id="sequence-project-id" name="bucket">
              <option value="0">------</option>
              {% for bucket_name in my_buckets %}
                <option value="{{ bucket_name }}">{{ bucket_name }}</option>
              {% endfor %}
            </select>
            <p>If you you dont see your assigned project in the list, please stop the process and contact the program coordinator</p>
          </div>
        {% endif %}
        </fieldset>
      </form>
    </div>
    <div id="step_2" class="form-step-item">
      <h3> Step 2: Tell us how you are going to run the sequencing</h3>
      <form id="step_2_form">
        <fieldset
          {% if my_buckets|length != 1 or process_data %}
           disabled="disabled"
          {% endif %}
        >
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="using_scripps"
              id="using_scripps_yes"
              value="1"
              {% if process_data and process_data.using_scripps %}
                checked
              {% endif %}
            >
            <label class="form-check-label" for="using_scripps_yes">
              We are using scripps and the data will be picked up by SPUN
            </label>
          </div>
          <div class="form-check">
            <input
              class="form-check-input"
              type="radio"
              name="using_scripps"
              id="using_scripps_no"
              value="2"
              {% if process_data and not process_data.using_scripps %}
                checked
              {% endif %}
            >
            <label class="form-check-label" for="using_scripps_no">
              We have done our analysis and we will upload the data here.
            </label>
          </div>
        </fieldset>
      </form>
    </div>

    <div id="step_3" class="form-step-item">
      <h3> Step 3: Give us the common data for your project</h3>
      <form id="step_3_form">
        <fieldset disabled="disabled">
          {% if my_buckets|length == 1 %}
            <input type="hidden" id="step_3_sequenceProjectId" value="{{ my_buckets|list|first }}"/>
          {% else %}
            <input type="hidden" id="step_3_sequenceProjectId" value=""/>
          {% endif %}
          {% for column_key, column_values in project_common_data.items() %}
            <div class="form-group row mb-3" data-condition="{{ column_values.get('required', '') }}">
              <small class="form-text text-danger error-message" style="display: none;"></small>
              <label for="{{ column_key }}" class="col-sm-3 col-form-label">{{ column_key }}</label>
              <div class="col-sm-9">
                <small id="{{ column_key }}Help" class="form-text">{{ column_values['help_tip'] }}</small>
                {% if 'options' in column_values %}
                  <select class="form-control" id="{{ column_key }}" name="{{ column_key }}">
                    <option value="0">------</option>
                    {% for option in column_values['options'] %}
                      <option value="{{ option }}"
                        {% if process_data and process_data[column_key] == option %}
                          selected
                        {% endif %}
                      >{{ option }}</option>
                    {% endfor %}
                  </select>
                {% elif column_values.get('field_type') == 'date' %}
                  <input type="date" class="form-control" id="{{ column_key }}" name="{{ column_key }}"
                    {% if process_data and process_data[column_key] %}
                      value="{{ process_data[column_key] }}"
                    {% endif %}
                  >
                {% else %}
                  <input type="text" class="form-control" id="{{ column_key }}" name="{{ column_key }}"
                    placeholder="{{ column_key }}"
                    {% if process_data and process_data[column_key] %}
                      value="{{ process_data[column_key] }}"
                    {% endif %}
                  >
                {% endif %}
              </div>
            </div>
          {% endfor %}
          <button type="button" class="btn btn-secondary" id="step_3_button">Process</button>
        </fieldset>
      </form>
      <div id="step_3_msg"></div>
    </div>


    <div id="step_4" class="form-step-item">
      <h3> Step 4: Select how you are going to give us the metadata</h3>
      <div>You can give us the metadata either by </div>
      <form id="step_4_form">
        <fieldset {% if not process_data %}disabled="disabled"{% endif %}>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="upload_method" id="upload_method_1" value="1">
            <label class="form-check-label" for="sequencing_method_1">
              Uploading a file of the format .xls or .csv
            </label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="upload_method" id="upload_method_2" value="2">
            <label class="form-check-label" for="sequencing_method_2">
              Filling in the form once for each of your samples
            </label>
          </div>
        </fieldset>
      </form>
      <div id="step_4_explanation_case_1" class="explanation" style="display:none;">
        <p>You have to upload a csv or xls file that the column names EXACTLY as they appear bellow. </p>
        <p>You can read the <a href="/metadata_fields_explanation" class="link" target="_blank">description of each field here TODO</a></p>
        <p>You can download the <a href="/metadata_xls_template" class="link" target="_blank">XLS template TODO</a></p>
        <p>Or the <a href="/metadata_csv_template" class="link" target="_blank">CSV template TODO</a></p>
        <form
            method="POST"
            action="/upload_metadata_file"
            enctype="multipart/form-data"
            id="step_4_file_upload"
        >
          <input type="hidden" name="project_id" value="{{ project_id }}">
          <input type="hidden" name="process_id" value="{{ process_id }}">
          <input type="file" id="step_4_file_upload_button" accept=".csv, .xls, .xlsx">
        </form>
      </div>
      <div id="step_4_explanation_case_2" class="explanation" style="display:none;">
        <p>Fill in the form bellow once for each sample. Pay very good attention to the coordinates.</p>
        <p>When you enter the coordinates the map should be showing you where this was.</p>
      </div>
      <div id="step_4_msg" class="explanation">

      </div>
    </div>

    <div class="table-container">
      <table id="dataTable" class="table-bordered">
        <thead>
          <tr>
            {% for expectedColumn in expected_columns.keys() %}
              <th scope="col">{{ expectedColumn }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
        </tbody>
      </table>

    </div>

    <div class="container">
      <div id="mapWrapper">
        <div id="map"></div>
      </div>
      <form id="metadataForm" style="display:none">
        {% for column_key, column_values in expected_columns.items() %}
            <div class="form-group row mb-3">
                <label for="{{ column_key }}" class="col-sm-3 col-form-label">{{ column_key }}</label>
                <div class="col-sm-9">
                    <small id="{{ column_key }}Help" class="form-text">{{ column_values['help_tip'] }}</small>
                    {% if 'options' in column_values %}
                        <select class="form-control" id="{{ column_key }}" name="{{ column_key }}">
                            <option value="0">------</option>
                            {% for option in column_values['options'] %}
                                <option value="{{ option }}">{{ option }}</option>
                            {% endfor %}
                        </select>
                    {% elif column_values.get('field_type') == 'date' %}
                        <input type="date" class="form-control" id="{{ column_key }}" name="{{ column_key }}">
                    {% else %}
                        <input type="text" class="form-control" id="{{ column_key }}" name="{{ column_key }}" placeholder="{{ column_key }}">
                    {% endif %}
                </div>
            </div>
        {% endfor %}

        <button type="submit" class="btn btn-primary">Submit</button>
      </form>
    </div>
    <div id="step_1_msg"></div>

  </div>

  <script type="application/javascript">
  var markersArray = [];
  var project_common_data = JSON.parse('{{ project_common_data|tojson|safe }}');
  //var expected_columns = JSON.parse('{{ expected_columns|tojson|safe }}');

  function addMarker(lat, lng) {
      var location = { lat: parseFloat(lat), lng: parseFloat(lng) };
      if (!isNaN(location.lat) && !isNaN(location.lng)) {
          var marker = new google.maps.marker.AdvancedMarkerElement({
              position: location,
              map: map
          });
          //var bounds = new google.maps.LatLngBounds();
          markersArray.push(marker);
          bounds.extend(location);
          map.fitBounds(bounds);

          var maxZoom = 14;
          var listener = google.maps.event.addListener(map, "idle", function () {
              if (map.getZoom() > maxZoom) map.setZoom(maxZoom);
              google.maps.event.removeListener(listener);
          });
      } else {
          console.error("Invalid latitude or longitude values.");
      }
  }

  $(document).ready(function() {
      // Function to enable the form
      function updateFields_step_3() {
        var usingScrippsNoChecked = $('#using_scripps_no').is(':checked');

        $('#step_3_form .form-group').each(function() {
          var condition = $(this).data('condition');
          if (condition === "IfNotScripps") {
            if (usingScrippsNoChecked) {
              $(this).show(); // Show the form group if condition matches and using_scripps_no is checked
            } else {
              $(this).hide(); // Hide the form group if condition matches and using_scripps_no is not checked
            }
          }
        });
      }

      function enableForm_step_2() {
          $('#step_2_form fieldset').removeAttr('disabled');
          $('#step_1_form fieldset').attr('disabled', 'disabled');
      }

      function enableForm_step_3() {
          $('#step_3_form fieldset').removeAttr('disabled');
          $('#step_2_form fieldset').attr('disabled', 'disabled');
      }

      function enableForm_step_4() {
          $('#step_4_form fieldset').removeAttr('disabled');
          $('#step_3_form fieldset').attr('disabled', 'disabled');
      }

      // Listen for changes in the select drop down project_id (bucket)
      $('#sequence-project-id').change(function() {
          var selectedValue = $(this).val();
          enableForm_step_2(); // Enable the next form
          $('#step_3_sequenceProjectId').val(selectedValue);
          console.log('Selected value:', selectedValue);
          // You can add more code here to handle the change event
      });

      // Listen for changes in the radio buttons using_scripps
      $('input[name="using_scripps"]').change(function() {
          // Check if any radio button is checked
          if ($('input[name="using_scripps"]:checked').length > 0) {
              enableForm_step_3(); // Enable the next form
          } else {
              $('#step_3_form fieldset').attr('disabled', 'disabled'); // Ensure the form is disabled if no radio button is checked
          }

          updateFields_step_3();
      });

      // Function to validate Step 3 fields
      function validateFieldsAndUpload_step_3() {
          var isValid = true;

          var formData = new FormData();
          // Get the value of the selected radio button from the using_scripps form
          var usingScrippsValue = $('input[name="using_scripps"]:checked').val();
          var usingScrippsText = usingScrippsValue == "1" ? "yes" : "no";
          formData.append('using_scripps', usingScrippsText);

          if ($('#sequence-project-id').is('input')) {
              var project_id = $('#sequence-project-id').val();
              console.log("Project ID from input field:", project_id);
          }
          // Check if the element is a select field
          else if ($('#sequence-project-id').is('select')) {
              $('#sequence-project-id').change(function() {
                  var project_id = $(this).val();
                  console.log("Selected Project ID from select field:", project_id);
              });
          }
          formData.append('project_id', project_id);

          $('#step_3_form .form-group').each(function() {
              var condition = $(this).data('condition');
              var input = $(this).find(':input');
              var fieldName = input.attr('name');
              var fieldValue = input.val();
              formData.append(fieldName, fieldValue);
              var errorMessage = $(this).find('.error-message');

              if ((condition === "True") || (condition === "IfNotScripps" && $('#using_scripps_no').is(':checked'))) {
                  // If condition requires field to be validated and using_scripps_no is not checked
                  if (input.is('select')) {
                      if (input.val() === "0") { // Assuming "0" is the default value
                          isValid = false;
                          errorMessage.text('Please select an option.').show();
                      } else {
                          errorMessage.text('').hide();
                      }
                  } else if (input.is('input[type="text"], input[type="date"]')) {
                      if (input.val() === "") {
                          isValid = false;
                          errorMessage.text('This field is required.').show();
                      } else {
                          errorMessage.text('').hide();
                      }
                  }
              } else {
                  errorMessage.text('').hide(); // Clear error message if condition is not met
              }
          });



          $.ajax({
              url: '/upload_process_common_fields',
              type: 'POST',
              data: formData,
              contentType: false,
              processData: false,
              success: function(response) {
                  console.log(response);
                  console.log(response.process_id);
                  if (response.result=="ok") {
                    window.location.replace("/metadata_form?process_id=" + response.process_id);
                  }

              },
              error: function(xhr, status, error) {
                  console.error('Error:', error);
                  $('#step_3_msg').html("<p>An error occurred while processing the file.</p>").removeClass('text-success').addClass('text-danger');

              }
          });

          return isValid;
      }


      // Validate Step 3 fields and enable Step 4 form on button click
      $('#step_3_button').click(function() {
          if (validateFieldsAndUpload_step_3()) {
              enableForm_step_4(); // Enable Step 4 form if Step 3 fields are valid
              $('#step_3_msg').text(`All data check out`).addClass('text-success').removeClass('text-info');
          } else {
              // Optionally, show error message or handle validation errors
              $('#step_3_msg').text(`Please fill out all required fields in Step 3.`).addClass('text-info').removeClass('text-success');
          }
      });

      updateFields_step_3();
  });


  $(document).ready(function() {
    $('input[name="upload_method"]').change(function() {
      if (this.value == '1') {
        $('#step_4_explanation_case_1').show();
        $('#step_4_explanation_case_2').hide();
        $('#metadataForm').hide();
      } else if (this.value == '2') {
        $('#step_4_explanation_case_1').hide();
        $('#step_4_explanation_case_2').show();
        $('#metadataForm').show();
      }
    });


    $('#latitude, #longitude').on('input', function() {
        var latitudeValue = $('#latitude').val().trim();
        var longitudeValue = $('#longitude').val().trim();

        // Regular expressions to match latitude and longitude in WGS1984 format
        var latitudePattern = /^[-+]?([1-8]?\d(\.\d+)?|90(\.0+)?)$/;
        var longitudePattern = /^[-+]?([1-9]?\d(\.\d+)?|1[0-7]\d(\.\d+)?|180(\.0+)?)$/;

        var latitudeValid = latitudePattern.test(latitudeValue);
        var longitudeValid = longitudePattern.test(longitudeValue);

        // Update help text and styles for latitude input
        if (!latitudeValid) {
            $('#latitudeHelp').text('Please enter a valid latitude in the WGS1984 format. Ideally in decimal format.').addClass('text-danger');
        } else {
            $('#latitudeHelp').text('Latitude of coordinates measured using WGS1984 (default on most GPS). Ideally in decimal format').removeClass('text-danger');
        }

        // Update help text and styles for longitude input
        if (!longitudeValid) {
            $('#longitudeHelp').text('Please enter a valid longitude in the WGS1984 format. Ideally in decimal format.').addClass('text-danger');
        } else {
            $('#longitudeHelp').text('Longitude of coordinates measured using WGS1984 (default on most GPS). Ideally in decimal format').removeClass('text-danger');
        }

        // Check if both latitude and longitude are valid
        if (latitudeValid && longitudeValid) {
            // Refresh the map and show marker at the specified coordinates
            var location = { lat: parseFloat(latitudeValue), lng: parseFloat(longitudeValue) };
            map.panTo(location);
            map.setZoom(14); // Set higher zoom level
            if (marker) {
                marker.position = location;
            } else {
              console.log(location);
                marker = new google.maps.marker.AdvancedMarkerElement({
                    position: location,
                    map: map
                });
            }
        }
    });


    // Submit form event handler
    $('#metadataForm').submit(function(event) {
        event.preventDefault(); // Prevent default form submission

        // Function to clear all error messages
        function clearErrors() {
            $('.error-message').remove();
        }

        function formatDateToDDMMYYYY(dateString) {
            const [year, month, day] = dateString.split("-");
            return `${day}/${month}/${year}`;
        }

        // Function to display error message
        function showError(input, message) {
            var errorElement = $(input).closest('.form-group').find('.error-message');
            if (errorElement.length === 0) {
                errorElement = $('<small class="form-text text-danger error-message"></small>');
                $(input).closest('.form-group').append(errorElement);
            }
            errorElement.text(message).show();
        }

        clearErrors(); // Clear existing error messages

        var formData = $(this).serializeArray();
        // Convert date fields to DD/MM/YYYY format
        formData.forEach(field => {
            // Find the corresponding input element
            var inputElement = $(`[name="${field.name}"]`);

            // Check if the input element is of type 'date'
            if (inputElement.attr('type') === 'date') {
                field.value = formatDateToDDMMYYYY(field.value);
            }
        });

        // Serialize the formData back to a URL-encoded string
        var serializedData = $.param(formData);

        // Send the form fields via AJAX to metadata_validate_row
        $.ajax({
            url: '/metadata_validate_row', // Adjust URL as needed
            type: 'POST',
            data: formData,
            dataType: 'json',
            success: function(response) {
              if (response.result.status === 0) {
                  Object.keys(response.result).forEach(field => {
                      if (field !== 'status') {
                          var fieldResult = response.result[field];
                          if (fieldResult.empty_values || fieldResult.invalid) {
                              var inputElement = $(`[name="${field}"]`);
                              inputElement.addClass('error');

                              var errorMessage = fieldResult.message;
                              if (fieldResult.invalid && fieldResult.invalid.length > 0) {
                                  errorMessage += ': ' + fieldResult.invalid[0].message;
                              }

                              inputElement.after(`<div class="text-danger error-message">${errorMessage}</div>`);
                          }
                      }
                  });
              } else {
                  // Extract latitude and longitude values if valid
                  var latitudeValue = '';
                  var longitudeValue = '';
                  formData.forEach(field => {
                      if (field.name === 'Latitude') latitudeValue = field.value;
                      if (field.name === 'Longitude') longitudeValue = field.value;
                  });

                  // Add marker if latitude and longitude are valid
                  if (latitudeValue && longitudeValue) {
                      addMarker(latitudeValue, longitudeValue);
                  }
                  console.log('Form submitted successfully');
              }
            },
            error: function(xhr, status, error) {
                $('#form_message').text('An error occurred. Please try again later.').addClass('text-danger').removeClass('text-success text-info').show();
            }
        });
    });

    // Clear error messages when user starts typing or selects an option
    $('#metadataForm :input').on('input change', function() {
        $(this).closest('.form-group').find('.error-message').remove();
    });
  });

  $(document).ready(function () {
      $('#step_4_file_upload_button').on('change', function () {
          uploadMetadataFile();
      });
  });

  function uploadMetadataFile() {
      var fileInput = $('#step_4_file_upload_button')[0];
      var file = fileInput.files[0];

      if (!file) {
          alert("Please select a file.");
          return;
      }

      // Clear previous table data
      $('#dataTable tbody').empty();

      // Get the value of the selected radio button from the using_scripps form
      var usingScrippsValue = $('input[name="using_scripps"]:checked').val();
      var usingScrippsText = usingScrippsValue == "1" ? "yes" : "no";

      var formData = new FormData();
      formData.append('file', file);
      formData.append('project_id', 1);
      formData.append('using_scripps', usingScrippsText);

      // Append data from step 3 form
      $('#step_3_form .form-group').each(function() {
          var input = $(this).find(':input');
          var fieldName = input.attr('name');
          var fieldValue = input.val();
          formData.append(fieldName, fieldValue);
      });

      $.ajax({
          url: '/upload_metadata_file',
          type: 'POST',
          data: formData,
          contentType: false,
          processData: false,
          success: function(response) {
              console.log(response);

              // Clear previous messages and reset status class
              $('#step_4_msg').empty().removeClass('text-success text-danger');
              var statusClass = 'text-success';

              // Clear previous markers from the map
              if (window.markersArray) {
                  markersArray.forEach(function(marker) {
                      marker.setMap(null);
                  });
              } else {
                  window.markersArray = [];
              }

              bounds = new google.maps.LatLngBounds();

              // Function to handle issues dynamically
              function handleIssues(fieldName, fieldData) {
                  if ((fieldData && fieldData.invalid) || (fieldData && fieldData.empty_values) || (fieldData && fieldData.missing)) {
                      var issueMsg = "<h4>Problems with field " + fieldName + "</h4>";
                      $('#step_4_msg').append(issueMsg);
                      if (fieldData && fieldData.invalid) {
                          var issueMsg = "<p>" + fieldData.message + "</p>";
                          $('#step_4_msg').append(issueMsg);
                          fieldData.invalid.forEach(function(entry) {
                              var detailedMsg = "<p> - " + entry.value + " in row " + (entry.row + 2) + "</p>";
                              $('#step_4_msg').append(detailedMsg);
                          });
                          statusClass = 'text-danger';
                      }
                      if (fieldData && fieldData.empty_values && fieldData.empty_values.length > 0) {
                          var emptyRows = fieldData.empty_values.map(function(row) {
                              return row + 2; // Adjust row number by 2 (header + zero-indexing)
                          });
                          var emptyMsg = "<p>Empty values for field " + fieldName + " in rows: " + emptyRows.join(", ") + "</p>";
                          $('#step_4_msg').append(emptyMsg);
                          statusClass = 'text-danger';
                      }
                      if (fieldData && fieldData.missing) {
                          var missingMsg = "<p>" + fieldData.message + "</p>";
                          $('#step_4_msg').append(missingMsg);
                          statusClass = 'text-danger';
                      }
                  }
              }

              var result = response['result'];
              // Dynamically handle all issues in response
              Object.keys(result).forEach(function(key) {
                  if (key !== 'status') {
                      handleIssues(key, result[key]);
                  }
              });

              var data = response['data'];
              var expectedColumns = response['expectedColumns'];

              // Generate table header
              var headerRow = '<tr>';
              expectedColumns.forEach(function(column) {
                  var hasIssues = result[column] && result[column].missing;
                  headerRow += '<th' + (hasIssues ? ' class="text-danger"' : '') + '>' + column + '</th>';
              });
              headerRow += '</tr>';
              $('#dataTable thead').html(headerRow);

              data.forEach(function(row, rowIndex) {
                  var tableRow = '<tr>';
                  var latitudeValue = null;
                  var longitudeValue = null;
                  var latitudeValid = false;
                  var longitudeValid = false;

                  expectedColumns.forEach(function(column) {
                      var cellValue = row[column];
                      if (cellValue !== undefined && cellValue !== null) {
                          cellValue = cellValue.toString();
                      } else {
                          cellValue = '';
                      }

                      // Check if this field had any problems
                      var hasIssues = result[column] && (result[column].invalid || result[column].empty_values);

                      // Check if this specific row has issues for the current column
                      var rowHasIssues = hasIssues && result[column].invalid && result[column].invalid.some(function(entry) {
                          return entry.row === rowIndex;
                      });

                      // Check if this row has empty values for the current column
                      var rowHasEmptyValues = hasIssues && result[column].empty_values && result[column].empty_values.includes(rowIndex);

                      // If it should not be empty but is and has issues for this row, show "MISSING" in red
                      if (rowHasEmptyValues) {
                          tableRow += '<td><span class="text-danger">MISSING</span></td>';
                      } else if (!cellValue && expectedColumns.includes(column) && rowHasIssues) {
                          tableRow += '<td><span class="text-danger">MISSING</span></td>';
                      } else {
                          // If there are issues for this row in this column, display the cell value in red
                          if (rowHasIssues) {
                              tableRow += '<td><span class="text-danger">' + cellValue + '</span></td>';
                          } else {
                              // Otherwise, display the cell value normally
                              tableRow += '<td>' + cellValue + '</td>';
                          }
                      }

                      // Extract latitude and longitude values
                      if (column === 'Latitude') {
                          latitudeValue = cellValue;
                          latitudeValid = !rowHasIssues && !rowHasEmptyValues && !isNaN(parseFloat(latitudeValue));
                      }
                      if (column === 'Longitude') {
                          longitudeValue = cellValue;
                          longitudeValid = !rowHasIssues && !rowHasEmptyValues && !isNaN(parseFloat(longitudeValue));
                      }
                  });
                  tableRow += '</tr>';
                  $('#dataTable tbody').append(tableRow);

                  // Check if both latitude and longitude are valid
                  if (latitudeValid && longitudeValid && latitudeValue && longitudeValue) {
                      var location = { lat: parseFloat(latitudeValue), lng: parseFloat(longitudeValue) };
                      if (!isNaN(location.lat) && !isNaN(location.lng)) {
                          var marker = new google.maps.marker.AdvancedMarkerElement({
                              position: location,
                              map: map
                          });
                          markersArray.push(marker); // Store marker in array
                          bounds.extend(location); // Extend the bounds to include this marker
                      } else {
                          console.error("Invalid latitude or longitude values.");
                      }
                  }
              });

              // Adjust the map's viewport to fit all markers
              if (markersArray.length > 0) {
                  map.fitBounds(bounds);

                  // Optionally, set a minimum zoom level
                  var maxZoom = 14;
                  var listener = google.maps.event.addListener(map, "idle", function() {
                      if (map.getZoom() > maxZoom) map.setZoom(maxZoom);
                      google.maps.event.removeListener(listener);
                  });
              }

              // Show success message if no issues found
              if (response.status === 1 && Object.keys(result).length === 1) {
                  $('#step_4_msg').append("<p>No problems found.</p>");
              }

              // Apply the appropriate status class
              $('#step_4_msg').addClass(statusClass);

              // Reset the file input
              fileInput.value = "";
          },
          error: function(xhr, status, error) {
              console.error('Error:', error);
              $('#step_4_msg').html("<p>An error occurred while processing the file.</p>").removeClass('text-success').addClass('text-danger');

              // Reset the file input
              fileInput.value = "";
          }
      });
  }






  </script>


  <script>

    let map;
    let bounds = new google.maps.LatLngBounds();;

    async function initMap() {
      const { Map } = await google.maps.importLibrary("maps");
      const { AdvancedMarkerElement, PinElement } = await google.maps.importLibrary("marker");

      map = new Map(document.getElementById("map"), {
        center: { lat: -34.397, lng: 150.644 },
        zoom: 8,
        mapId: "SEQ_SAMPLE_POSITION",
      });
    }

    initMap();
  </script>
  <style>
    #map {
      height: 100%;
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }
    #mapWrapper {
      height: 350px;
      width: 700px;
    }

    .table-container {
        overflow-x: auto; /* Enable horizontal scrolling */
    }

  </style>
</body>
</html>
